# Shift Scheduler AI - プロジェクト共通ルール

## 🚨 コード修正時の必須ルール（最重要）

### 0. 修正内容の理解と確認（最優先）
- **大規模な変更や複数ファイルの修正を行う前に、必ず修正内容をユーザーに確認する**
- ユーザーの指示が曖昧な場合や複数の解釈が可能な場合は、AskUserQuestion ツールを使って明確化する
- 直前の会話内容と矛盾する変更を行おうとする場合は、必ず立ち止まって確認する
- 「何を」「どのように」変更するのか、自分の理解を明示してからユーザーの承認を得る

### 0.5. 設計書・実行計画作成プロセス（ソースコード修正前に必ず実施）

#### 🚫 絶対厳守：設計書承認前のコード修正禁止
- **設計書の承認が得られるまで、絶対にソースコードを修正してはいけない**
- **設計書の承認 = ソースコード作成開始の合図**
- 承認が得られない場合は、設計書を修正して再度承認を求める

#### 設計書作成の手順
1. **要件確認**
   - 修正内容について不明点があれば、AskUserQuestion ツールでユーザーに確認
   - 曖昧な点を一つ残らずクリアにする

2. **影響調査（最重要）**
   - **フロントエンド・バックエンド・データベース全領域を漏れなく調査**
   - Grep ツールで修正対象の関数・変数・テーブル名を検索
   - **参照元（どこから呼ばれているか）**を完全にリストアップ
   - **参照先（どこを呼んでいるか）**を完全にリストアップ
   - データベーススキーマへの影響を確認
   - API レスポンス形式の変更がフロントエンドに与える影響を確認
   - 影響があるファイルをすべて特定し、リスト化

3. **設計書作成**
   - HTML形式で設計書を作成
   - ファイル名：`docs/design-docs/YYYYMMDD_<修正概要>.html`
   - 設計書に含めるべき内容：
     - **修正の目的・背景**
     - **影響範囲の完全なリスト**
       - フロントエンド：影響を受けるコンポーネント・関数
       - バックエンド：影響を受けるAPI・関数・サービス
       - データベース：影響を受けるテーブル・カラム・クエリ
     - **参照元・参照先の完全なリスト**
     - **修正前後の動作比較**
     - **想定されるリスクと対策**
     - **テスト計画**（該当する場合）
     - **実行計画**（次のセクション参照）

4. **実行計画作成**
   - 影響範囲を考慮して、コミット分割戦略を立てる
   - 実行計画に含めるべき内容：
     - **コミット数**：何個のコミットに分けるか
     - **コミット順序**：どのような順番でコミットするか
     - **各コミットの内容**：それぞれのコミットで何を変更するか
     - **各コミットの依存関係**：前のコミットが必要な理由
     - **ロールバック計画**：問題が起きた場合の戻し方
   - 影響範囲が大きい場合は、段階的なリリース計画も検討
   - **進捗管理**：
     - 実行計画にはチェックボックス形式で進捗を追えるようにする
     - 各タスク完了時に、設計書HTMLのチェックボックスを更新する
     - 更新した設計書は必ず上書き保存し、次のコミットに含める

5. **承認取得**
   - 設計書と実行計画をユーザーに提示
   - **承認が得られるまで実装を開始しない**
   - 承認が得られない場合は、フィードバックに基づいて設計書を修正

6. **実装開始**
   - **承認後のみ**、実行計画に従ってソースコード修正を開始
   - 実行計画通りの順序でコミットを作成
   - **各タスク完了ごとに設計書のチェックボックスを更新**（忘れずに実施）
   - 各コミットには更新された設計書を含める

#### ディレクトリ構造
```
docs/
└── design-docs/
    ├── 20251114_shift_date_timezone_fix.html
    ├── 20251115_multi_store_display_feature.html
    └── ...
```

### 1. 影響範囲の確認（修正前に必ず実施）
- **絶対にいきなり修正しない**
- 修正対象のファイル名・関数名・変数名を明示する
- Grepで使用箇所をすべて検索し、影響範囲を特定する
- 影響を受けるファイルをリスト化してユーザーに報告する
- **ユーザーの承認を得てから修正を実行する**

### 2. 段階的な修正（一度に1つずつ）
- **一度に複数ファイルを修正しない**
- 1ファイルずつ修正し、ユーザーの確認を得る
- 修正前に「このファイルを修正します」と明示する
- 修正後、「この修正で問題ないか」確認を求める

### 3. 既存機能を壊さない
- 既存のテストがある場合は、修正前後で実行する
- 既存の動作を変更する場合は、必ず理由を説明する
- 「動いていたものを壊す」ことは絶対に避ける

### 4. 修正内容の明確な説明
- 何を修正したか
- なぜ修正したか
- どのような影響があるか
- を必ず説明する

---

## 📐 プロジェクト固有のルール

### バックエンドAPI修正時の注意

#### シフトデータ取得API (`backend/src/routes/shifts.js`)
- **重要**: `store_id` でフィルタする場合は `sh.store_id` を使用する
  ```javascript
  // ❌ 間違い
  if (store_id) {
    sql += ` AND staff.store_id = $${paramIndex}`;
  }

  // ✅ 正しい
  if (store_id) {
    sql += ` AND sh.store_id = $${paramIndex}`;
  }
  ```
- 理由: スタッフの所属店舗ではなく、シフトの勤務店舗でフィルタする（応援勤務対応）

#### データ取得とフィルタリングの設計思想
- **バックエンド**: 全店舗データを取得（`planId` のみ指定）
- **フロントエンド**: `selectedStores` で表示を絞り込む
- ユーザーがチェックボックスで自由に店舗を切り替えられる設計

### 日付処理の注意

#### 日付の扱い方
- データベース: 日付は `YYYY-MM-DD` 形式の文字列でJSTとして保存
- フロントエンド: 日付は `YYYY-MM-DD` 形式の文字列として扱う
- **タイムゾーン変換は不要** - すべてJSTで統一
- **`new Date()` を使わない** - 日付文字列を直接扱う
- パース処理が必要な場合は `dateUtils.js` の既存関数を使用する

#### よくある日付ズレの原因
- `new Date()` で日付オブジェクトに変換してしまう（タイムゾーンの影響を受ける）
- APIから返ってきた日付文字列を不用意にパースする
- 日付計算時にDateオブジェクトを経由してしまう

#### 正しい日付の扱い方
```javascript
// ❌ 間違い - Dateオブジェクトに変換するとタイムゾーンの影響を受ける
const date = new Date('2025-07-03')  // UTCとして解釈される可能性

// ✅ 正しい - 文字列のまま扱う
const dateStr = '2025-07-03'
const year = dateStr.split('-')[0]
const month = dateStr.split('-')[1]
const day = dateStr.split('-')[2]

// ✅ 正しい - 比較も文字列で
if (dateStr === '2025-07-03') { ... }
if (dateStr >= '2025-07-01' && dateStr <= '2025-07-31') { ... }
```

### 店舗フィルタリングのパターン

#### 初期表示の設定 (`selectedStores`)
```javascript
// 特定店舗から遷移した場合
if (storeId) {
  setSelectedStores(new Set([parseInt(storeId)]))  // その店舗のみ選択
} else {
  setSelectedStores(new Set(stores.map(s => parseInt(s.store_id))))  // 全店舗選択
}
```

#### データ取得
```javascript
// 全店舗データを取得（planIdのみ指定）
const shifts = await shiftRepository.getShifts({ planId })
```

#### 表示フィルタリング
- `MultiStoreShiftTable` コンポーネントが `selectedStores` を使って表示を制御
- チェックボックスで `selectedStores` を更新すると、表示が切り替わる

---

## 🗂️ プロジェクト構造

### フロントエンド
```
frontend/
├── src/
│   ├── components/
│   │   ├── screens/        # 画面コンポーネント
│   │   │   ├── shift/      # シフト関連画面
│   │   │   │   ├── ShiftManagement.jsx       # シフト管理（トップ）
│   │   │   │   ├── DraftShiftEditor.jsx      # 第1案編集
│   │   │   │   ├── SecondPlan.jsx            # 第2案編集
│   │   │   │   ├── History.jsx               # 履歴
│   │   │   │   └── MultiStoreHistory.jsx     # マルチストア履歴
│   │   │   └── (その他の画面)
│   │   ├── shared/         # 共有コンポーネント
│   │   │   ├── MultiStoreShiftTable.jsx     # マルチストアシフト表
│   │   │   ├── ShiftCalendar.jsx            # シフトカレンダー
│   │   │   └── AppHeader.jsx                # ヘッダー
│   │   └── ui/             # UIコンポーネント（shadcn/ui）
│   ├── infrastructure/     # インフラ層
│   │   ├── repositories/   # リポジトリ
│   │   └── api/            # API クライアント
│   ├── utils/              # ユーティリティ
│   │   ├── dateUtils.js    # 日付処理
│   │   ├── csvHelper.js    # CSV処理
│   │   └── shiftValidator.js  # バリデーション
│   ├── config/             # 設定
│   └── contexts/           # React Context
└── (設定ファイル)
```

### バックエンド
```
backend/
├── src/
│   ├── routes/             # APIルート
│   │   ├── shifts.js       # シフトAPI（最重要）
│   │   ├── master.js       # マスターデータAPI
│   │   └── (その他のAPI)
│   ├── services/           # ビジネスロジック
│   ├── config/             # 設定
│   └── utils/              # ユーティリティ
└── (設定ファイル)
```

---

## 🔍 デバッグ時のチェックポイント

### フロントエンド
1. ブラウザのコンソールログを確認
2. React DevTools でpropsを確認
3. ネットワークタブでAPIレスポンスを確認
4. `selectedStores` の中身を確認（店舗フィルタリング問題時）

### バックエンド
1. サーバーログを確認
2. SQLクエリをログ出力して確認
3. データベースを直接クエリして確認
4. APIレスポンスの内容を確認

---

## 🎯 よくある問題と解決方法

### 問題1: チェックボックスを入れても他店舗が表示されない
**原因**: バックエンドのフィルタリング条件が `staff.store_id` になっている
**解決**: `sh.store_id` に修正

### 問題2: 日付が1日ずれる
**原因**: `new Date()` でDateオブジェクトに変換してタイムゾーンの影響を受けている
**解決**: 日付文字列 (`YYYY-MM-DD`) を直接扱う。Dateオブジェクトに変換しない

### 問題3: 編集画面でクリックが効かない
**原因**: `readonly={true}` になっている、またはイベントハンドラが未定義
**解決**: `readonly={false}` を確認、`onUpdateShift` などが渡されているか確認

### 問題4: 画面遷移がうまくいかない
**原因**: `currentStep` の設定ミス、またはフラグの競合
**解決**: `App.jsx` の遷移ロジックを確認、全フラグをリセットしてから目的の画面を表示

---

## 📝 Git コミットメッセージ

以下の形式を推奨：
```
<type>: <subject>

<body>

🤖 Generated with Claude Code
Co-Authored-By: Claude <noreply@anthropic.com>
```

**type**:
- `fix`: バグ修正
- `feat`: 新機能
- `refactor`: リファクタリング
- `docs`: ドキュメント
- `test`: テスト追加
- `chore`: その他

---

## 🚀 開発ワークフロー

1. イシューを確認
2. 影響範囲を調査
3. 修正計画をユーザーに報告
4. 承認を得てから修正実施
5. 修正内容を確認
6. テスト実行（将来）
7. コミット・プッシュ

---

## 📚 参考情報

- フロントエンド: React 18 + Vite
- バックエンド: Express.js + PostgreSQL
- スタイリング: Tailwind CSS + shadcn/ui
- 状態管理: React hooks (useState, useEffect)
- ルーティング: React Router v6
