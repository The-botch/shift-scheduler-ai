import { useState, useEffect, useRef } from 'react'
import { motion, AnimatePresence } from 'framer-motion'
import { Card, CardContent, CardHeader, CardTitle } from '../ui/card'
import { Button } from '../ui/button'
import {
  Sparkles,
  CheckCircle,
  Loader2,
  Calendar as CalendarIcon,
  MessageSquare,
  Send,
  Minimize2,
  GripVertical,
  Upload,
  Settings,
} from 'lucide-react'
import ShiftTimeline from '../shared/ShiftTimeline'
import { ShiftRepository } from '../../infrastructure/repositories/ShiftRepository'
import { MasterRepository } from '../../infrastructure/repositories/MasterRepository'

const shiftRepository = new ShiftRepository()
const masterRepository = new MasterRepository()

const pageVariants = {
  initial: { opacity: 0, y: 20 },
  in: { opacity: 1, y: 0 },
  out: { opacity: 0, y: -20 },
}

const pageTransition = {
  type: 'tween',
  ease: 'anticipate',
  duration: 0.5,
}

// ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒ“ãƒ¥ãƒ¼ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
const CalendarView = ({ calendarData, onDayClick }) => {
  if (!calendarData) return null

  const { daysInMonth, firstDay, shiftsByDate } = calendarData
  const weekDays = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ']

  // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚°ãƒªãƒƒãƒ‰ç”¨ã®é…åˆ—ã‚’ä½œæˆ
  const calendarDays = []
  // æœˆåˆã®ç©ºã‚»ãƒ«
  for (let i = 0; i < firstDay; i++) {
    calendarDays.push(null)
  }
  // æ—¥ä»˜ã‚»ãƒ«
  for (let day = 1; day <= daysInMonth; day++) {
    calendarDays.push(day)
  }

  return (
    <div>
      {/* æ›œæ—¥ãƒ˜ãƒƒãƒ€ãƒ¼ */}
      <div className="grid grid-cols-7 gap-1 mb-2">
        {weekDays.map(day => (
          <div key={day} className="p-1 text-center text-xs font-bold bg-blue-50 rounded">
            {day}
          </div>
        ))}
      </div>

      {/* ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚°ãƒªãƒƒãƒ‰ */}
      <div className="grid grid-cols-7 gap-1">
        {calendarDays.map((day, index) => {
          if (!day) {
            // ç©ºã‚»ãƒ«
            return <div key={`empty-${index}`} className="min-h-[60px]" />
          }

          const dayShifts = shiftsByDate[day] || []
          const dayOfWeek = (firstDay + day - 1) % 7
          const isWeekend = dayOfWeek === 0 || dayOfWeek === 6
          const hasModified = dayShifts.some(s => s.modified_flag)

          return (
            <motion.div
              key={day}
              className={`p-1 border rounded min-h-[60px] cursor-pointer hover:shadow-md transition-shadow ${
                hasModified
                  ? 'bg-yellow-50 border-yellow-300 hover:bg-yellow-100'
                  : isWeekend
                    ? 'bg-blue-50 border-blue-200 hover:bg-blue-100'
                    : 'border-gray-200 hover:bg-gray-50'
              }`}
              initial={{ opacity: 0, scale: 0.9 }}
              animate={{ opacity: 1, scale: 1 }}
              transition={{ delay: index * 0.01 }}
              onClick={() => dayShifts.length > 0 && onDayClick(day, dayShifts)}
            >
              <div
                className={`text-xs font-bold mb-0.5 ${
                  hasModified ? 'text-yellow-700' : 'text-gray-700'
                }`}
              >
                {day}
              </div>
              {dayShifts.slice(0, 2).map((shift, idx) => (
                <div
                  key={idx}
                  className="text-xs p-0.5 rounded mb-0.5 bg-green-100 border border-green-300"
                >
                  <div className="font-medium text-green-800 text-xs leading-tight truncate">
                    {shift.staff_name}
                  </div>
                </div>
              ))}
              {dayShifts.length > 2 && (
                <div className="text-xs text-gray-500">+{dayShifts.length - 2}</div>
              )}
            </motion.div>
          )
        })}
      </div>
    </div>
  )
}

const FirstPlan = ({ onNext: _onNext, onPrev, onApprove, onMarkUnsaved, onMarkSaved, selectedShift, onGoToGenerationSettings }) => {
  const [generating, setGenerating] = useState(false)
  const [generated, setGenerated] = useState(false)
  const [shiftData, setShiftData] = useState([])
  const [loading, setLoading] = useState(true)
  const [stats, setStats] = useState({
    totalShifts: 0,
    totalHours: 0,
    staffCount: 0,
  })

  // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒ“ãƒ¥ãƒ¼ç”¨ã®çŠ¶æ…‹
  const [showCalendarView, setShowCalendarView] = useState(false)
  const [calendarData, setCalendarData] = useState(null)

  // selectedShiftã‹ã‚‰æƒ…å ±ã‚’å–å¾—
  const planId = selectedShift?.planId || selectedShift?.plan_id || null
  const currentYear = selectedShift?.year || new Date().getFullYear()
  const currentMonth = selectedShift?.month || new Date().getMonth() + 1
  const isDraft = selectedShift?.status === 'draft'

  console.log('FirstPlan mounted with:', {
    selectedShift,
    planId,
    currentYear,
    currentMonth,
    isDraft
  })

  // ãƒãƒ£ãƒƒãƒˆæ©Ÿèƒ½é–¢é€£ã®çŠ¶æ…‹å¤‰æ•°
  const [messages, setMessages] = useState([
    {
      id: 1,
      type: 'system',
      content:
        'ç¬¬1æ¡ˆãŒç”Ÿæˆã•ã‚Œã¾ã—ãŸã€‚ã“ã®æ¡ˆã§å•é¡Œãªã‘ã‚Œã°æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã¸é€²ã‚“ã§ãã ã•ã„ã€‚ä¿®æ­£ãŒå¿…è¦ãªå ´åˆã¯ã€è‡ªç„¶è¨€èªã§æŒ‡ç¤ºã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚',
      time: '14:30',
    },
  ])
  const [inputValue, setInputValue] = useState('')
  const [isTyping, setIsTyping] = useState(false)
  const [pendingChange, setPendingChange] = useState(null)
  const [isChatMinimized, setIsChatMinimized] = useState(false)
  const [chatPosition, setChatPosition] = useState({
    x: window.innerWidth - 336,
    y: window.innerHeight - 520,
  })
  const [chatSize, setChatSize] = useState({ width: 320, height: 500 })
  const [isDragging, setIsDragging] = useState(false)
  const [isResizing, setIsResizing] = useState(false)
  const [dragStart, setDragStart] = useState({ x: 0, y: 0 })
  const chatEndRef = useRef(null)
  const [changedDates, setChangedDates] = useState(new Set())

  // ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³è¡¨ç¤ºç”¨
  const [selectedDay, setSelectedDay] = useState(null)
  const [dayShifts, setDayShifts] = useState([])

  // ã‚·ãƒ•ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€
  useEffect(() => {
    if (planId) {
      loadShiftData()
    } else {
      // æ–°è¦ä½œæˆã®å ´åˆã¯ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚’çµ‚äº†
      console.log('FirstPlan: æ–°è¦ä½œæˆãƒ¢ãƒ¼ãƒ‰ï¼ˆplanIdãªã—ï¼‰')
      setLoading(false)
      setGenerated(false)
    }
  }, [planId])

  const loadShiftData = async () => {
    try {
      setLoading(true)

      // planIdãŒæŒ‡å®šã•ã‚Œã¦ã„ãªã„å ´åˆã¯ã‚¨ãƒ©ãƒ¼
      if (!planId) {
        console.error('planIdãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“')
        setLoading(false)
        return
      }

      console.log('FirstPlan: Loading shift data for planId:', planId)

      // APIã‹ã‚‰ä¸¦è¡Œèª­ã¿è¾¼ã¿
      const [shiftsResult, staffResult, rolesResult] = await Promise.all([
        shiftRepository.getShifts({ planId: planId }),
        masterRepository.getStaff(),
        masterRepository.getRoles(),
      ])

      // å½¹è·IDã‹ã‚‰å½¹è·åã¸ã®ãƒãƒƒãƒ”ãƒ³ã‚°
      const rolesMap = {}
      rolesResult.forEach(role => {
        rolesMap[role.role_id] = role.role_name
      })

      // ã‚¹ã‚¿ãƒƒãƒ•IDã‹ã‚‰åå‰ãƒ»å½¹è·ã¸ã®ãƒãƒƒãƒ”ãƒ³ã‚°
      const staffMap = {}
      staffResult.forEach(staff => {
        staffMap[staff.staff_id] = {
          name: staff.name,
          role_id: staff.role_id,
          role_name: rolesMap[staff.role_id] || 'ã‚¹ã‚¿ãƒƒãƒ•',
        }
      })

      // æ—¥ä»˜åˆ¥ã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
      const groupedByDate = {}
      shiftsResult.forEach(shift => {
        const date = shift.shift_date.split('T')[0] // ISOå½¢å¼ã‹ã‚‰æ—¥ä»˜éƒ¨åˆ†ã‚’å–å¾—
        if (!groupedByDate[date]) {
          groupedByDate[date] = []
        }
        const staffInfo = staffMap[shift.staff_id] || { name: 'ä¸æ˜', role_name: 'ã‚¹ã‚¿ãƒƒãƒ•' }
        groupedByDate[date].push({
          name: staffInfo.name,
          role: staffInfo.role_name,
          time: `${shift.start_time?.substring(0, 5)}-${shift.end_time?.substring(0, 5)}`,
          skill: shift.assigned_skills?.length || 3,
          hours: parseFloat(shift.total_hours) || 0,
        })
      })

      // æ—¥ä»˜é †ã«ã‚½ãƒ¼ãƒˆ
      const sortedDates = Object.keys(groupedByDate).sort()

      // 1æ—¥ã‹ã‚‰é€£ç•ªã§æ ¼ç´
      const formattedData = sortedDates.map((date, index) => ({
        date: index + 1,
        fullDate: date,
        shifts: groupedByDate[date],
      }))

      console.log('CSVã‹ã‚‰èª­ã¿è¾¼ã‚“ã ãƒ‡ãƒ¼ã‚¿:', formattedData.length, 'æ—¥åˆ†')
      console.log('ã‚¹ã‚¿ãƒƒãƒ•æ•°:', Object.keys(staffMap).length)

      // CSVãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨
      console.log(`CSVãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨ã—ã¾ã™ (${formattedData.length}æ—¥åˆ†)`)
      setShiftData(formattedData)

      // çµ±è¨ˆæƒ…å ±ã‚’è¨ˆç®—
      const totalShifts = shiftsResult.length
      const totalHours = shiftsResult.reduce((sum, s) => sum + (s.total_hours || 0), 0)
      const staffCount = Object.keys(staffMap).length

      setStats({ totalShifts, totalHours, staffCount })

      // ä¸‹æ›¸ãã®å ´åˆã¯ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒ“ãƒ¥ãƒ¼ã‚‚æº–å‚™
      console.log('Shift status check:', {
        status: selectedShift?.status,
        planId: selectedShift?.plan_id,
        isDraft: selectedShift?.status === 'draft'
      })

      if (selectedShift?.status === 'draft') {
        console.log('ä¸‹æ›¸ããƒ¢ãƒ¼ãƒ‰: ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒ“ãƒ¥ãƒ¼ã‚’æº–å‚™ã—ã¾ã™')
        console.log('Shifts count:', shiftsResult.length)
        console.log('Staff map size:', Object.keys(staffMap).length)
        prepareCalendarView(shiftsResult, staffMap)
        setShowCalendarView(true)
        setGenerated(true)
        console.log('Calendar view setup complete')
      }

      setLoading(false)
    } catch (err) {
      console.error('ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', err)
      setShiftData([])
      setStats({ totalShifts: 0, totalHours: 0, staffCount: 0 })
      setLoading(false)
      alert('ã‚·ãƒ•ãƒˆãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚')
    }
  }

  // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒ“ãƒ¥ãƒ¼ç”¨ã®ãƒ‡ãƒ¼ã‚¿ã‚’æº–å‚™
  const prepareCalendarView = (shifts, staffMap) => {
    console.log('prepareCalendarView called with:', {
      shiftsCount: shifts.length,
      staffCount: Object.keys(staffMap).length,
      currentYear,
      currentMonth
    })

    // æ—¥ä»˜åˆ¥ã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
    const shiftsByDate = {}
    shifts.forEach(shift => {
      const date = new Date(shift.shift_date)
      const day = date.getDate()

      if (!shiftsByDate[day]) {
        shiftsByDate[day] = []
      }

      const staffInfo = staffMap[shift.staff_id] || { name: 'ä¸æ˜', role_name: 'ã‚¹ã‚¿ãƒƒãƒ•' }
      shiftsByDate[day].push({
        ...shift,
        staff_name: staffInfo.name,
        role: staffInfo.role_name,
        modified_flag: false
      })
    })

    // æœˆã®æƒ…å ±ã‚’è¨ˆç®—
    const date = new Date(currentYear, currentMonth - 1, 1)
    const daysInMonth = new Date(currentYear, currentMonth, 0).getDate()
    const firstDay = date.getDay()

    const calData = {
      daysInMonth,
      firstDay,
      shiftsByDate,
      year: currentYear,
      month: currentMonth
    }

    console.log('Setting calendar data:', calData)
    console.log('Days with shifts:', Object.keys(shiftsByDate))

    setCalendarData(calData)
  }

  const generateFirstPlan = () => {
    setGenerating(true)
    setTimeout(() => {
      setGenerating(false)
      setGenerated(true)
    }, 3000)
  }

  // CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆå‡¦ç†
  const handleCSVImport = event => {
    const file = event.target.files[0]
    if (!file) return

    setGenerating(true)

    const reader = new FileReader()
    reader.onload = e => {
      const csvContent = e.target.result

      // CSVã‚’ãƒ‘ãƒ¼ã‚¹
      Papa.parse(csvContent, {
        header: true,
        dynamicTyping: true,
        skipEmptyLines: true,
        complete: result => {
          console.log('âœ… CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ:', file.name, result.data.length, 'ä»¶')

          // ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ãŸãƒ‡ãƒ¼ã‚¿ã‚’æ—¢å­˜ã®shiftDataå½¢å¼ã«å¤‰æ›
          // shift.csvã®å½¢å¼ã‚’æƒ³å®š: date, staff_name, start_time, end_time, role, etc.
          const groupedByDate = {}

          result.data.forEach(row => {
            const date = row.date || row.shift_date?.split('-')[2] || row.day
            if (!date) return

            if (!groupedByDate[date]) {
              groupedByDate[date] = {
                date: parseInt(date),
                shifts: [],
                totalStaff: 0,
                totalHours: 0,
              }
            }

            // æ™‚é–“è¨ˆç®—
            const startHour = parseInt((row.start_time || '09:00').split(':')[0])
            const endHour = parseInt((row.end_time || '18:00').split(':')[0])
            const hours = endHour - startHour

            groupedByDate[date].shifts.push({
              name: row.staff_name || row.name || 'ã‚¹ã‚¿ãƒƒãƒ•',
              time: `${row.start_time || '09:00'}-${row.end_time || '18:00'}`,
              role: row.role || 'ã‚¹ã‚¿ãƒƒãƒ•',
              hours: hours,
            })

            groupedByDate[date].totalStaff++
            groupedByDate[date].totalHours += hours
          })

          // é…åˆ—ã«å¤‰æ›ã—ã¦ã‚½ãƒ¼ãƒˆ
          const importedShiftData = Object.values(groupedByDate).sort((a, b) => a.date - b.date)

          // çµ±è¨ˆã‚’è¨ˆç®—
          const totalShifts = result.data.length
          const totalHours = importedShiftData.reduce((sum, day) => sum + day.totalHours, 0)
          const staffSet = new Set(result.data.map(row => row.staff_name || row.name))
          const staffCount = staffSet.size

          setShiftData(importedShiftData)
          setStats({
            totalShifts,
            totalHours,
            staffCount,
          })

          setGenerating(false)
          setGenerated(true)

          console.log('âœ… ã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Œäº†:', {
            æ—¥æ•°: importedShiftData.length,
            ã‚·ãƒ•ãƒˆæ•°: totalShifts,
            ã‚¹ã‚¿ãƒƒãƒ•æ•°: staffCount,
            ç·åŠ´åƒæ™‚é–“: totalHours,
          })
        },
        error: error => {
          console.error('CSVãƒ‘ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼:', error)
          setGenerating(false)
          alert('CSVãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ')
        },
      })
    }

    reader.onerror = () => {
      console.error('ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼')
      setGenerating(false)
      alert('ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ')
    }

    reader.readAsText(file)
  }

  const handleApprove = () => {
    // æ‰¿èªæ™‚ã«å±¥æ­´ãƒ‡ãƒ¼ã‚¿ã¨ã—ã¦ä¿å­˜
    const approvedData = {
      month: 7,
      year: 2025,
      status: 'first_plan_approved',
      approvedAt: new Date().toISOString(),
      shifts: shiftData,
      stats: stats,
    }

    // LocalStorageã«ä¿å­˜
    localStorage.setItem('approved_first_plan_2025_07', JSON.stringify(approvedData))
    console.log('ç¬¬1æ¡ˆã‚’ä»®æ‰¿èªã—ã¾ã—ãŸã€‚å±¥æ­´ã«ä¿å­˜ã•ã‚Œã¾ã—ãŸã€‚')

    // è¦ªã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®æ‰¿èªå‡¦ç†ã‚’å‘¼ã³å‡ºã—
    if (onApprove) {
      onApprove()
    }
  }

  // ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³è¡¨ç¤ºç”¨ã®é–¢æ•°ï¼ˆã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒ“ãƒ¥ãƒ¼ã‹ã‚‰å‘¼ã°ã‚Œã‚‹ç‰ˆï¼‰
  const handleDayClickFromCalendar = (day, dayShifts) => {
    // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒ‡ãƒ¼ã‚¿å½¢å¼ã‚’ShiftTimelineç”¨ã«å¤‰æ›
    const formattedShifts = dayShifts.map(shift => ({
      shift_id: shift.shift_id,
      staff_name: shift.staff_name,
      start_time: shift.start_time?.substring(0, 5) || '09:00',
      end_time: shift.end_time?.substring(0, 5) || '18:00',
      role: shift.role || 'ã‚¹ã‚¿ãƒƒãƒ•',
      planned_hours: shift.total_hours || 0,
      modified_flag: shift.modified_flag || false,
    }))
    setDayShifts(formattedShifts)
    setSelectedDay(day)
  }

  // ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³è¡¨ç¤ºç”¨ã®é–¢æ•°ï¼ˆæ—¢å­˜ã®ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‹ã‚‰å‘¼ã°ã‚Œã‚‹ç‰ˆï¼‰
  const handleDayClick = dayData => {
    // FirstPlanã®ãƒ‡ãƒ¼ã‚¿å½¢å¼ã‚’ShiftTimelineç”¨ã«å¤‰æ›
    const formattedShifts = dayData.shifts.map((shift, index) => {
      const [startTime, endTime] = shift.time.split('-')
      return {
        shift_id: `shift-${dayData.date}-${index}`,
        staff_name: shift.name,
        start_time: startTime,
        end_time: endTime,
        role: shift.role || 'ã‚¹ã‚¿ãƒƒãƒ•',
        planned_hours: shift.hours,
        modified_flag: shift.changed || false,
      }
    })
    setDayShifts(formattedShifts)
    setSelectedDay(dayData.date)
  }

  const closeDayView = () => {
    setSelectedDay(null)
    setDayShifts([])
  }

  // ãƒãƒ£ãƒƒãƒˆè‡ªå‹•ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«é–¢æ•°
  const scrollToBottom = () => {
    setTimeout(() => {
      if (chatEndRef.current) {
        chatEndRef.current.scrollIntoView({ behavior: 'smooth' })
      }
    }, 100)
  }

  // ãƒ‰ãƒ©ãƒƒã‚°ãƒãƒ³ãƒ‰ãƒ©ãƒ¼
  const handleDragStart = e => {
    setIsDragging(true)
    setDragStart({
      x: e.clientX - chatPosition.x,
      y: e.clientY - chatPosition.y,
    })
  }

  const handleDrag = e => {
    if (isDragging) {
      setChatPosition({
        x: e.clientX - dragStart.x,
        y: e.clientY - dragStart.y,
      })
    }
  }

  const handleDragEnd = () => {
    setIsDragging(false)
  }

  // ãƒªã‚µã‚¤ã‚ºãƒãƒ³ãƒ‰ãƒ©ãƒ¼
  const handleResizeStart = e => {
    e.stopPropagation()
    setIsResizing(true)
    setDragStart({ x: e.clientX, y: e.clientY })
  }

  const handleResize = e => {
    if (isResizing) {
      const deltaX = e.clientX - dragStart.x
      const deltaY = e.clientY - dragStart.y
      setChatSize({
        width: Math.max(280, chatSize.width + deltaX),
        height: Math.max(300, chatSize.height + deltaY),
      })
      setDragStart({ x: e.clientX, y: e.clientY })
    }
  }

  const handleResizeEnd = () => {
    setIsResizing(false)
  }

  // ãƒã‚¦ã‚¹ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
  useEffect(() => {
    if (isDragging) {
      window.addEventListener('mousemove', handleDrag)
      window.addEventListener('mouseup', handleDragEnd)
      return () => {
        window.removeEventListener('mousemove', handleDrag)
        window.removeEventListener('mouseup', handleDragEnd)
      }
    }
  }, [isDragging, dragStart, chatPosition])

  useEffect(() => {
    if (isResizing) {
      window.addEventListener('mousemove', handleResize)
      window.addEventListener('mouseup', handleResizeEnd)
      return () => {
        window.removeEventListener('mousemove', handleResize)
        window.removeEventListener('mouseup', handleResizeEnd)
      }
    }
  }, [isResizing, dragStart, chatSize])

  // ãƒ‡ãƒ¢ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆç¬¬1æ¡ˆç”¨ã«èª¿æ•´ï¼‰
  const demoPatterns = {
    '5æ—¥ã®ç”°ä¸­ã•ã‚“ã‚’ä½è—¤ã•ã‚“ã«å¤‰æ›´ã—ã¦ãã ã•ã„': {
      analysis: {
        changes: '5æ—¥: ç”°ä¸­ã•ã‚“ â†’ ä½è—¤ã•ã‚“ã«å¤‰æ›´',
        impacts: [
          'ã‚¹ã‚­ãƒ«ãƒ¬ãƒ™ãƒ«: â˜…â˜…â˜…â˜… â†’ â˜…â˜…â˜…â˜…â˜…ã«å‘ä¸Š',
          'ç”°ä¸­ã•ã‚“ã®é€±é–“å‹¤å‹™: 32æ™‚é–“ â†’ 28æ™‚é–“',
          'ä½è—¤ã•ã‚“ã®é€±é–“å‹¤å‹™: 32æ™‚é–“ â†’ 36æ™‚é–“',
          'ã‚µãƒ¼ãƒ“ã‚¹å“è³ªãŒå‘ä¸Š',
        ],
        question: 'ã“ã®å¤‰æ›´ã‚’å®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿã€ŒOKã€ã¨å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚',
      },
      changes: [
        { date: 5, action: 'modify', staff: 'ç”°ä¸­', newStaff: 'ä½è—¤', time: '9-17', skill: 5 },
      ],
      response:
        'âœ… å¤‰æ›´ã‚’å®Ÿè¡Œã—ã¾ã—ãŸ\nâ€¢ 5æ—¥ã®ç”°ä¸­ã•ã‚“ã‚’ä½è—¤ã•ã‚“ã«å¤‰æ›´\nâ€¢ ã‚¹ã‚­ãƒ«ãƒ¬ãƒ™ãƒ«ãŒâ˜…â˜…â˜…â˜…â˜…ã«å‘ä¸Š\nâ€¢ ã‚µãƒ¼ãƒ“ã‚¹å“è³ªãŒæ”¹å–„',
    },
    '10æ—¥ã«å±±ç”°ã•ã‚“ã‚’è¿½åŠ ã—ã¦ãã ã•ã„': {
      analysis: {
        changes: '10æ—¥: å±±ç”°ã•ã‚“ã‚’è¿½åŠ é…ç½®',
        impacts: [
          '10æ—¥ã®äººå“¡ä¸è¶³ãŒè§£æ¶ˆã•ã‚Œã¾ã™',
          'å±±ç”°ã•ã‚“ã®é€±é–“å‹¤å‹™: 30æ™‚é–“ â†’ 34æ™‚é–“',
          'å……è¶³ç‡: 85% â†’ 88%ã«å‘ä¸Š',
          'æ¥­å‹™ã®å®‰å®šæ€§ãŒå‘ä¸Š',
        ],
        question: 'ã“ã®å¤‰æ›´ã‚’å®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿã€ŒOKã€ã¨å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚',
      },
      changes: [{ date: 10, action: 'add', staff: 'å±±ç”°', time: '13-17', skill: 3 }],
      response:
        'âœ… å¤‰æ›´ã‚’å®Ÿè¡Œã—ã¾ã—ãŸ\nâ€¢ 10æ—¥ã«å±±ç”°ã•ã‚“ã‚’è¿½åŠ é…ç½®\nâ€¢ äººå“¡ä¸è¶³ã‚’è§£æ¶ˆ\nâ€¢ å……è¶³ç‡88%ã«å‘ä¸Š',
    },
    '15æ—¥ã®éˆ´æœ¨ã•ã‚“ã‚’å‰Šé™¤ã—ã¦ãã ã•ã„': {
      analysis: {
        changes: '15æ—¥: éˆ´æœ¨ã•ã‚“ã‚’å‰Šé™¤',
        impacts: [
          '15æ—¥ã®äººå“¡éå¤š(3åâ†’2å)ãŒè§£æ¶ˆ',
          'éˆ´æœ¨ã•ã‚“ã®é€±é–“å‹¤å‹™: 34æ™‚é–“ â†’ 30æ™‚é–“',
          'äººä»¶è²»å‰Šæ¸›: Â¥4,000',
          'é©æ­£äººå“¡é…ç½®ã«èª¿æ•´',
        ],
        question: 'ã“ã®å¤‰æ›´ã‚’å®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿã€ŒOKã€ã¨å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚',
      },
      changes: [{ date: 15, action: 'remove', staff: 'éˆ´æœ¨' }],
      response:
        'âœ… å¤‰æ›´ã‚’å®Ÿè¡Œã—ã¾ã—ãŸ\nâ€¢ 15æ—¥ã®éˆ´æœ¨ã•ã‚“ã‚’å‰Šé™¤\nâ€¢ äººå“¡éå¤šã‚’è§£æ¶ˆ(3åâ†’2å)\nâ€¢ äººä»¶è²»Â¥4,000å‰Šæ¸›',
    },
    '20æ—¥ã®é«˜æ©‹ã•ã‚“ã‚’åˆå‰ã‚·ãƒ•ãƒˆã«å¤‰æ›´ã—ã¦ãã ã•ã„': {
      analysis: {
        changes: '20æ—¥: é«˜æ©‹ã•ã‚“ã®æ™‚é–“å¸¯ã‚’9-13æ™‚ã«å¤‰æ›´',
        impacts: [
          'åˆå‰ã®äººå“¡ä¸è¶³ãŒè§£æ¶ˆ',
          'é«˜æ©‹ã•ã‚“ã®å¸Œæœ›é©åˆåº¦: 65% â†’ 82%ã«å‘ä¸Š',
          'åˆå¾Œã¯ä½è—¤ã•ã‚“ã‚’è‡ªå‹•é…ç½®',
          'å…¨ä½“æº€è¶³åº¦ãŒå‘ä¸Š',
        ],
        question: 'ã“ã®å¤‰æ›´ã‚’å®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿã€ŒOKã€ã¨å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚',
      },
      changes: [{ date: 20, action: 'modify', staff: 'é«˜æ©‹', time: '9-13', skill: 4 }],
      response:
        'âœ… å¤‰æ›´ã‚’å®Ÿè¡Œã—ã¾ã—ãŸ\nâ€¢ 20æ—¥ã®é«˜æ©‹ã•ã‚“ã‚’åˆå‰ã‚·ãƒ•ãƒˆã«å¤‰æ›´\nâ€¢ å¸Œæœ›é©åˆåº¦82%ã«å‘ä¸Š\nâ€¢ åˆå‰ã®äººå“¡ä¸è¶³ã‚’è§£æ¶ˆ',
    },
    '25æ—¥ã®åˆå¾Œã‚¹ã‚¿ãƒƒãƒ•ã‚’1åæ¸›ã‚‰ã—ã¦ãã ã•ã„': {
      analysis: {
        changes: '25æ—¥åˆå¾Œ: ä¼Šè—¤ã•ã‚“ã‚’å‰Šé™¤',
        impacts: [
          '25æ—¥åˆå¾Œã®äººå“¡éå¤šãŒè§£æ¶ˆ',
          'ä¼Šè—¤ã•ã‚“ã®é€±é–“å‹¤å‹™: 33æ™‚é–“ â†’ 29æ™‚é–“',
          'äººä»¶è²»å‰Šæ¸›: Â¥3,200',
          'é©æ­£äººå“¡ã«èª¿æ•´',
        ],
        question: 'ã“ã®å¤‰æ›´ã‚’å®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿã€ŒOKã€ã¨å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚',
      },
      changes: [{ date: 25, action: 'remove', staff: 'ä¼Šè—¤' }],
      response:
        'âœ… å¤‰æ›´ã‚’å®Ÿè¡Œã—ã¾ã—ãŸ\nâ€¢ 25æ—¥åˆå¾Œã®ä¼Šè—¤ã•ã‚“ã‚’å‰Šé™¤\nâ€¢ äººå“¡éå¤šã‚’è§£æ¶ˆ\nâ€¢ äººä»¶è²»Â¥3,200å‰Šæ¸›',
    },
  }

  const applyShiftChanges = changes => {
    // å¤‰æ›´ãŒã‚ã£ãŸã“ã¨ã‚’ãƒãƒ¼ã‚¯
    if (onMarkUnsaved) {
      onMarkUnsaved()
    }

    setShiftData(prevData => {
      const newData = [...prevData]
      const newChangedDates = new Set(changedDates)

      changes.forEach(change => {
        const dayIndex = newData.findIndex(d => d.date === change.date)
        if (dayIndex !== -1) {
          newChangedDates.add(change.date)

          if (change.action === 'remove') {
            newData[dayIndex].shifts = newData[dayIndex].shifts.filter(s => s.name !== change.staff)
          } else if (change.action === 'add') {
            newData[dayIndex].shifts.push({
              name: change.staff,
              time: change.time,
              skill: change.skill,
              hours: 4,
              changed: true,
            })
          } else if (change.action === 'modify') {
            const shiftIndex = newData[dayIndex].shifts.findIndex(s => s.name === change.staff)
            if (shiftIndex !== -1) {
              if (change.newStaff) {
                // ã‚¹ã‚¿ãƒƒãƒ•å¤‰æ›´
                newData[dayIndex].shifts[shiftIndex] = {
                  name: change.newStaff,
                  time: change.time,
                  skill: change.skill,
                  hours: 4,
                  changed: true,
                }
              } else {
                // æ™‚é–“å¤‰æ›´
                newData[dayIndex].shifts[shiftIndex] = {
                  ...newData[dayIndex].shifts[shiftIndex],
                  time: change.time,
                  changed: true,
                }
              }
            }
          }
        }
      })

      setChangedDates(newChangedDates)
      return newData
    })
  }

  const sendMessage = (messageText = null) => {
    const textToSend = messageText || inputValue
    if (!textToSend.trim()) return

    const newMessage = {
      id: messages.length + 1,
      type: 'user',
      content: textToSend,
      time: new Date().toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' }),
    }

    setMessages(prev => [...prev, newMessage])
    const currentInput = textToSend
    setInputValue('')
    setIsTyping(true)
    scrollToBottom()

    // æ‰¿èªå¾…ã¡çŠ¶æ…‹ã®å‡¦ç†
    if (
      pendingChange &&
      (currentInput.toLowerCase().includes('ok') ||
        currentInput.includes('ã¯ã„') ||
        currentInput.includes('å®Ÿè¡Œ'))
    ) {
      setTimeout(() => {
        applyShiftChanges(pendingChange.changes)
        const aiResponse = {
          id: messages.length + 2,
          type: 'assistant',
          content: pendingChange.response,
          time: new Date().toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' }),
        }
        setMessages(prev => [...prev, aiResponse])
        setIsTyping(false)
        setPendingChange(null)
        scrollToBottom()
      }, 1500)
      return
    }

    // ãƒ‡ãƒ¢ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ãƒã‚§ãƒƒã‚¯
    const pattern = demoPatterns[currentInput]

    setTimeout(() => {
      if (pattern) {
        // å½±éŸ¿åˆ†æã‚’è¡¨ç¤º
        const analysisContent = `ğŸ“‹ å¤‰æ›´äºˆå®š:\nâ€¢ ${pattern.analysis.changes}\n\nâš ï¸ å½±éŸ¿åˆ†æ:\n${pattern.analysis.impacts.map(impact => `â€¢ ${impact}`).join('\n')}\n\n${pattern.analysis.question}`

        const aiResponse = {
          id: messages.length + 2,
          type: 'assistant',
          content: analysisContent,
          time: new Date().toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' }),
        }
        setMessages(prev => [...prev, aiResponse])
        setPendingChange(pattern)
        scrollToBottom()
      } else {
        const aiResponse = {
          id: messages.length + 2,
          type: 'assistant',
          content:
            'ç”³ã—è¨³ã”ã–ã„ã¾ã›ã‚“ãŒã€ãã®æŒ‡ç¤ºã¯èªè­˜ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚ä»¥ä¸‹ã®ä¾‹ã‚’å‚è€ƒã«ã—ã¦ãã ã•ã„ï¼š\n\nâ€¢ 5æ—¥ã®ç”°ä¸­ã•ã‚“ã‚’ä½è—¤ã•ã‚“ã«å¤‰æ›´ã—ã¦ãã ã•ã„\nâ€¢ 10æ—¥ã«å±±ç”°ã•ã‚“ã‚’è¿½åŠ ã—ã¦ãã ã•ã„\nâ€¢ 15æ—¥ã®éˆ´æœ¨ã•ã‚“ã‚’å‰Šé™¤ã—ã¦ãã ã•ã„\nâ€¢ 20æ—¥ã®é«˜æ©‹ã•ã‚“ã‚’åˆå‰ã‚·ãƒ•ãƒˆã«å¤‰æ›´ã—ã¦ãã ã•ã„',
          time: new Date().toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' }),
        }
        setMessages(prev => [...prev, aiResponse])
        scrollToBottom()
      }
      setIsTyping(false)
    }, 2000)
  }

  if (loading) {
    return (
      <motion.div
        initial="initial"
        animate="in"
        exit="out"
        variants={pageVariants}
        transition={pageTransition}
        className="container mx-auto px-4 py-8"
      >
        <div className="flex flex-col items-center justify-center min-h-[400px]">
          <Loader2 className="h-12 w-12 animate-spin text-blue-600 mb-4" />
          <p className="text-lg text-gray-600">ãƒ‡ãƒ¼ã‚¿ã‚’æº–å‚™ã—ã¦ã„ã¾ã™...</p>
        </div>
      </motion.div>
    )
  }

  // ä¸‹æ›¸ãé–²è¦§ãƒ¢ãƒ¼ãƒ‰ã®å ´åˆï¼ˆã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆã¯å¿…ãšè¡¨ç¤ºï¼‰
  console.log('Render check:', {
    showCalendarView,
    hasCalendarData: !!calendarData,
    isDraft,
    generated,
    hasShiftData: shiftData.length
  })

  // ä¸‹æ›¸ãã§ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Œã°è¡¨ç¤ºï¼ˆgeneratedã¯ä¸è¦ï¼‰
  if (isDraft && calendarData) {
    console.log('ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒ“ãƒ¥ãƒ¼ã‚’è¡¨ç¤ºã—ã¾ã™', calendarData)
    return (
      <motion.div
        initial="initial"
        animate="in"
        exit="out"
        variants={pageVariants}
        transition={pageTransition}
        className="container mx-auto px-4 py-8"
      >
        <Card className="shadow-lg border-0">
          <CardContent className="p-6">
            <CalendarView calendarData={calendarData} onDayClick={handleDayClickFromCalendar} />
          </CardContent>
        </Card>

        {/* ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³è¡¨ç¤º */}
        <AnimatePresence>
          {selectedDay && (
            <ShiftTimeline
              date={selectedDay}
              year={currentYear}
              month={currentMonth}
              shifts={dayShifts}
              onClose={closeDayView}
            />
          )}
        </AnimatePresence>
      </motion.div>
    )
  }

  return (
    <motion.div
      initial="initial"
      animate="in"
      exit="out"
      variants={pageVariants}
      transition={pageTransition}
      className="container mx-auto px-4 py-8"
    >

      {!generated ? (
        <Card className="shadow-lg border-0">
          <CardContent className="p-12 text-center">
            {generating ? (
              <motion.div initial={{ opacity: 0 }} animate={{ opacity: 1 }}>
                <div className="w-24 h-24 bg-gradient-to-br from-purple-100 to-blue-100 rounded-full flex items-center justify-center mx-auto mb-6">
                  <motion.div
                    animate={{ rotate: 360 }}
                    transition={{ duration: 2, repeat: Infinity, ease: 'linear' }}
                  >
                    <Sparkles className="h-12 w-12 text-purple-600" />
                  </motion.div>
                </div>
                <h3 className="text-2xl font-bold mb-4">AIãŒã‚·ãƒ•ãƒˆã‚’ç”Ÿæˆä¸­...</h3>
                <div className="max-w-md mx-auto">
                  <div className="bg-gray-200 rounded-full h-2 mb-4">
                    <motion.div
                      className="bg-gradient-to-r from-purple-600 to-blue-600 h-2 rounded-full"
                      initial={{ width: 0 }}
                      animate={{ width: '100%' }}
                      transition={{ duration: 3 }}
                    />
                  </div>
                  <p className="text-gray-600">åˆ¶ç´„æ¡ä»¶ã‚’è€ƒæ…®ã—ã€æœ€é©ãªã‚·ãƒ•ãƒˆã‚’è¨ˆç®—ä¸­...</p>
                </div>
              </motion.div>
            ) : (
              <>
                <div className="w-24 h-24 bg-gradient-to-br from-purple-100 to-blue-100 rounded-full flex items-center justify-center mx-auto mb-6">
                  <Sparkles className="h-12 w-12 text-purple-600" />
                </div>
                <h3 className="text-2xl font-bold mb-4">AIè‡ªå‹•ã‚·ãƒ•ãƒˆç”Ÿæˆ</h3>
                <p className="text-gray-600 mb-8">
                  ã‚¹ã‚¿ãƒƒãƒ•æƒ…å ±ã¨åˆ¶ç´„æ¡ä»¶ã‹ã‚‰ã€æœ€é©ãªã‚·ãƒ•ãƒˆã‚’è‡ªå‹•ç”Ÿæˆã—ã¾ã™
                  <br />
                  èª­ã¿è¾¼ã¿å®Œäº†: {shiftData.length}æ—¥åˆ†ã€{stats.staffCount}åã®ã‚¹ã‚¿ãƒƒãƒ•
                </p>
                <div className="flex flex-col gap-3">
                  <Button
                    onClick={generateFirstPlan}
                    size="lg"
                    className="bg-gradient-to-r from-purple-600 to-blue-600 hover:from-purple-700 hover:to-blue-700"
                  >
                    <Sparkles className="mr-2 h-5 w-5" />
                    è‡ªå‹•ç”Ÿæˆã‚’é–‹å§‹
                  </Button>

                  <div className="relative">
                    <div className="absolute inset-0 flex items-center">
                      <div className="w-full border-t border-gray-300"></div>
                    </div>
                    <div className="relative flex justify-center text-sm">
                      <span className="px-2 bg-white text-gray-500">ã¾ãŸã¯</span>
                    </div>
                  </div>

                  <Button
                    onClick={onGoToGenerationSettings}
                    className="w-full bg-blue-600 hover:bg-blue-700 h-11"
                    size="lg"
                  >
                    <Settings className="mr-2 h-5 w-5" />
                    ç”Ÿæˆè¨­å®š
                  </Button>
                </div>
              </>
            )}
          </CardContent>
        </Card>
      ) : (
        <div className="space-y-6">
          {/* 2ã‚«ãƒ©ãƒ ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */}
          <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
            {/* å·¦å´ï¼šã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ */}
            <Card className="shadow-lg border-0">
              <CardHeader className="pb-3">
                <CardTitle className="flex items-center text-lg">
                  <CalendarIcon className="h-5 w-5 mr-2 text-blue-600" />
                  10æœˆã®ã‚·ãƒ•ãƒˆï¼ˆ{shiftData.length}æ—¥åˆ†ï¼‰
                </CardTitle>
              </CardHeader>
              <CardContent>
                <div className="grid grid-cols-7 gap-1 mb-2">
                  {['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'].map(day => (
                    <div key={day} className="p-1 text-center text-xs font-bold bg-blue-50 rounded">
                      {day}
                    </div>
                  ))}
                </div>

                <div className="grid grid-cols-7 gap-1">
                  {/* 2025å¹´7æœˆ1æ—¥ã¯ç«æ›œæ—¥ãªã®ã§ã€ç©ºç™½ã‚»ãƒ«ã‚’2ã¤è¿½åŠ ï¼ˆæ—¥æ›œãƒ»æœˆæ›œï¼‰ */}
                  {[0, 1].map(i => (
                    <div key={`empty-${i}`} className="p-1"></div>
                  ))}
                  {shiftData.map((dayData, index) => {
                    // 2025å¹´7æœˆ1æ—¥ã¯ç«æ›œæ—¥ã€æ—¥æ›œå§‹ã¾ã‚Šã®ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãªã®ã§+2
                    const dayOfWeekIndex = (dayData.date - 1 + 2) % 7
                    const isWeekend = dayOfWeekIndex === 0 || dayOfWeekIndex === 6 // æ—¥æ›œ(0)ã¨åœŸæ›œ(6)
                    const isChanged = changedDates.has(dayData.date)

                    return (
                      <motion.div
                        key={index}
                        className={`p-1 border rounded min-h-[60px] cursor-pointer hover:shadow-md transition-shadow ${
                          isChanged
                            ? 'bg-green-50 border-green-400 hover:bg-green-100'
                            : isWeekend
                              ? 'bg-blue-50 border-blue-200 hover:bg-blue-100'
                              : 'border-gray-200 hover:bg-gray-50'
                        }`}
                        initial={{ opacity: 0, scale: 0.9 }}
                        animate={{ opacity: 1, scale: 1 }}
                        transition={{ delay: index * 0.01 }}
                        onClick={() => handleDayClick(dayData)}
                      >
                        <div
                          className={`text-xs font-bold mb-0.5 ${
                            isChanged ? 'text-green-700' : 'text-gray-700'
                          }`}
                        >
                          {dayData.date}
                          {isChanged && (
                            <CheckCircle className="h-2.5 w-2.5 inline ml-1 text-green-600" />
                          )}
                        </div>
                        {dayData.shifts.slice(0, 2).map((shift, idx) => (
                          <motion.div
                            key={idx}
                            className={`text-xs p-0.5 rounded mb-0.5 ${
                              shift.changed
                                ? 'bg-green-200 border border-green-400'
                                : 'bg-green-100 border border-green-300'
                            }`}
                            initial={{ opacity: 0 }}
                            animate={{ opacity: 1 }}
                            transition={{ delay: index * 0.01 + idx * 0.05 }}
                          >
                            <div className="font-medium text-green-800 text-xs leading-tight">
                              {shift.name}
                            </div>
                          </motion.div>
                        ))}
                        {dayData.shifts.length > 2 && (
                          <div className="text-xs text-gray-500">+{dayData.shifts.length - 2}</div>
                        )}
                      </motion.div>
                    )
                  })}
                </div>

                <div className="mt-3 flex items-center gap-3 text-xs">
                  <div className="flex items-center">
                    <div className="w-2.5 h-2.5 bg-green-100 border border-green-300 rounded mr-1.5"></div>
                    <span>é…ç½®æ¸ˆã¿</span>
                  </div>
                  <div className="flex items-center">
                    <div className="w-2.5 h-2.5 bg-green-200 border border-green-400 rounded mr-1.5"></div>
                    <span>ä¿®æ­£æ¸ˆã¿</span>
                  </div>
                  <div className="flex items-center">
                    <div className="w-2.5 h-2.5 bg-blue-50 border border-blue-200 rounded mr-1.5"></div>
                    <span>åœŸæ—¥</span>
                  </div>
                </div>
              </CardContent>
            </Card>

            {/* å³å´ï¼šçµ±è¨ˆæƒ…å ± */}
            <div className="space-y-6">
              <Card className="shadow-lg border-0">
                <CardHeader>
                  <CardTitle>ç”Ÿæˆçµæœã‚µãƒãƒªãƒ¼</CardTitle>
                </CardHeader>
                <CardContent className="space-y-4">
                  <div className="flex justify-between items-center">
                    <span className="text-gray-600">ç·ã‚·ãƒ•ãƒˆæ•°</span>
                    <span className="text-2xl font-bold text-blue-600">{stats.totalShifts}</span>
                  </div>
                  <div className="flex justify-between items-center">
                    <span className="text-gray-600">ç·åŠ´åƒæ™‚é–“</span>
                    <span className="text-2xl font-bold text-green-600">
                      {stats.totalHours.toFixed(1)}h
                    </span>
                  </div>
                  <div className="flex justify-between items-center">
                    <span className="text-gray-600">ã‚«ãƒãƒ¬ãƒƒã‚¸</span>
                    <span className="text-2xl font-bold text-purple-600">94.8%</span>
                  </div>
                  <div className="flex justify-between items-center">
                    <span className="text-gray-600">åˆ¶ç´„é•å</span>
                    <span className="text-2xl font-bold text-green-600">0ä»¶</span>
                  </div>
                </CardContent>
              </Card>

              <Card className="shadow-lg border-0 bg-green-50 border-green-200">
                <CardHeader>
                  <CardTitle className="flex items-center text-green-800">
                    <CheckCircle className="h-5 w-5 mr-2" />
                    æ³•ä»¤éµå®ˆãƒã‚§ãƒƒã‚¯
                  </CardTitle>
                </CardHeader>
                <CardContent>
                  <div className="space-y-2 text-sm">
                    <div className="flex items-center text-green-700">
                      <CheckCircle className="h-4 w-4 mr-2" />
                      åŠ´åƒåŸºæº–æ³•ç¬¬32æ¡ï¼ˆæ³•å®šåŠ´åƒæ™‚é–“ï¼‰
                    </div>
                    <div className="flex items-center text-green-700">
                      <CheckCircle className="h-4 w-4 mr-2" />
                      åŠ´åƒåŸºæº–æ³•ç¬¬34æ¡ï¼ˆä¼‘æ†©æ™‚é–“ï¼‰
                    </div>
                    <div className="flex items-center text-green-700">
                      <CheckCircle className="h-4 w-4 mr-2" />
                      åŠ´åƒåŸºæº–æ³•ç¬¬35æ¡ï¼ˆæ³•å®šä¼‘æ—¥ï¼‰
                    </div>
                    <div className="flex items-center text-green-700">
                      <CheckCircle className="h-4 w-4 mr-2" />
                      åŠ´åƒåŸºæº–æ³•ç¬¬61æ¡ï¼ˆå¹´å°‘è€…ä¿è­·ï¼‰
                    </div>
                  </div>
                </CardContent>
              </Card>

              {/* ä¿®æ­£ä¾‹ã®ã‚«ãƒ¼ãƒ‰ */}
              <Card className="shadow-lg border-0 bg-blue-50 border-blue-200">
                <CardHeader>
                  <CardTitle className="flex items-center text-blue-800">
                    <MessageSquare className="h-5 w-5 mr-2" />
                    AIä¿®æ­£ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ
                  </CardTitle>
                </CardHeader>
                <CardContent>
                  <p className="text-sm text-blue-700 mb-3">
                    å³ä¸‹ã®ãƒãƒ£ãƒƒãƒˆãƒœãƒƒãƒˆã§è‡ªç„¶è¨€èªã«ã‚ˆã‚‹ä¿®æ­£ãŒå¯èƒ½ã§ã™
                  </p>
                  <div className="text-xs text-blue-600 space-y-1">
                    <div>â€¢ 5æ—¥ã®ç”°ä¸­ã•ã‚“ã‚’ä½è—¤ã•ã‚“ã«å¤‰æ›´ã—ã¦ãã ã•ã„</div>
                    <div>â€¢ 10æ—¥ã«å±±ç”°ã•ã‚“ã‚’è¿½åŠ ã—ã¦ãã ã•ã„</div>
                    <div>â€¢ 15æ—¥ã®éˆ´æœ¨ã•ã‚“ã‚’å‰Šé™¤ã—ã¦ãã ã•ã„</div>
                  </div>
                </CardContent>
              </Card>
            </div>
          </div>

          {/* ãƒ‰ãƒ©ãƒƒã‚°å¯èƒ½ãªãƒãƒ£ãƒƒãƒˆã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ */}
          {isChatMinimized ? (
            // æœ€å°åŒ–çŠ¶æ…‹
            <motion.div
              initial={{ scale: 0.8, opacity: 0 }}
              animate={{ scale: 1, opacity: 1 }}
              className="fixed bottom-4 right-4 z-50"
            >
              <Button
                onClick={() => setIsChatMinimized(false)}
                size="lg"
                className="bg-blue-600 hover:bg-blue-700 text-white rounded-full w-16 h-16 shadow-2xl flex items-center justify-center"
              >
                <MessageSquare className="h-6 w-6" />
              </Button>
            </motion.div>
          ) : (
            // å±•é–‹çŠ¶æ…‹
            <motion.div
              initial={{ scale: 0.8, opacity: 0 }}
              animate={{ scale: 1, opacity: 1 }}
              className="fixed z-50 bg-white rounded-lg shadow-2xl border border-gray-200"
              style={{
                left: `${chatPosition.x}px`,
                top: `${chatPosition.y}px`,
                width: `${chatSize.width}px`,
                height: `${chatSize.height}px`,
                cursor: isDragging ? 'move' : 'default',
              }}
            >
              <div
                className="flex items-center justify-between p-4 border-b border-gray-200 bg-blue-600 text-white rounded-t-lg cursor-move"
                onMouseDown={handleDragStart}
              >
                <div className="flex items-center">
                  <GripVertical className="h-4 w-4 mr-2 opacity-70" />
                  <MessageSquare className="h-5 w-5 mr-2" />
                  <span className="font-medium">AIä¿®æ­£ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ</span>
                </div>
                <Button
                  variant="ghost"
                  size="sm"
                  onClick={() => setIsChatMinimized(true)}
                  className="text-white hover:bg-blue-700 h-8 w-8 p-0"
                >
                  <Minimize2 className="h-4 w-4" />
                </Button>
              </div>
              <div className="flex flex-col" style={{ height: `${chatSize.height - 60}px` }}>
                <div className="flex-1 overflow-y-auto p-4 space-y-3">
                  {messages.map(message => (
                    <motion.div
                      key={message.id}
                      initial={{ opacity: 0, y: 10 }}
                      animate={{ opacity: 1, y: 0 }}
                      className={`flex ${message.type === 'user' ? 'justify-end' : 'justify-start'}`}
                    >
                      <div
                        className={`max-w-xs px-3 py-2 rounded-lg text-sm whitespace-pre-line ${
                          message.type === 'user'
                            ? 'bg-blue-600 text-white'
                            : 'bg-gray-100 text-gray-800'
                        }`}
                      >
                        <div>{message.content}</div>
                        <div
                          className={`text-xs mt-1 ${
                            message.type === 'user' ? 'text-blue-100' : 'text-gray-500'
                          }`}
                        >
                          {message.time}
                        </div>
                      </div>
                    </motion.div>
                  ))}
                  {isTyping && (
                    <motion.div
                      initial={{ opacity: 0 }}
                      animate={{ opacity: 1 }}
                      className="flex justify-start"
                    >
                      <div className="bg-gray-100 px-3 py-2 rounded-lg">
                        <div className="flex space-x-1">
                          <div className="w-2 h-2 bg-gray-400 rounded-full animate-bounce"></div>
                          <div
                            className="w-2 h-2 bg-gray-400 rounded-full animate-bounce"
                            style={{ animationDelay: '0.1s' }}
                          ></div>
                          <div
                            className="w-2 h-2 bg-gray-400 rounded-full animate-bounce"
                            style={{ animationDelay: '0.2s' }}
                          ></div>
                        </div>
                      </div>
                    </motion.div>
                  )}
                  <div ref={chatEndRef} />
                </div>
                <div className="p-4 border-t border-gray-200">
                  {pendingChange ? (
                    // æ‰¿èªå¾…ã¡çŠ¶æ…‹ã®æ™‚ã¯OKãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
                    <div className="flex space-x-2">
                      <Button
                        onClick={() => sendMessage('OK')}
                        className="flex-1 bg-green-600 hover:bg-green-700 text-white"
                      >
                        âœ“ OKï¼ˆå¤‰æ›´ã‚’å®Ÿè¡Œï¼‰
                      </Button>
                      <Button
                        onClick={() => {
                          setPendingChange(null)
                          const cancelMessage = {
                            id: messages.length + 1,
                            type: 'assistant',
                            content: 'å¤‰æ›´ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸã€‚',
                            time: new Date().toLocaleTimeString('ja-JP', {
                              hour: '2-digit',
                              minute: '2-digit',
                            }),
                          }
                          setMessages(prev => [...prev, cancelMessage])
                        }}
                        variant="outline"
                        className="border-gray-300"
                      >
                        ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                      </Button>
                    </div>
                  ) : (
                    // é€šå¸¸çŠ¶æ…‹
                    <div className="flex space-x-2">
                      <input
                        type="text"
                        value={inputValue}
                        onChange={e => setInputValue(e.target.value)}
                        placeholder="ä¿®æ­£æŒ‡ç¤ºã‚’å…¥åŠ›..."
                        className="flex-1 px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                        onKeyPress={e => e.key === 'Enter' && sendMessage()}
                      />
                      <Button
                        onClick={sendMessage}
                        size="sm"
                        className="bg-blue-600 hover:bg-blue-700"
                      >
                        <Send className="h-4 w-4" />
                      </Button>
                    </div>
                  )}
                </div>
              </div>
              {/* ãƒªã‚µã‚¤ã‚ºãƒãƒ³ãƒ‰ãƒ« */}
              <div
                className="absolute bottom-0 right-0 w-4 h-4 cursor-nwse-resize"
                onMouseDown={handleResizeStart}
                style={{
                  background: 'linear-gradient(135deg, transparent 50%, #cbd5e1 50%)',
                  borderBottomRightRadius: '0.5rem',
                }}
              />
            </motion.div>
          )}
        </div>
      )}

      {/* ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³è¡¨ç¤º */}
      <AnimatePresence>
        {selectedDay && (
          <ShiftTimeline
            date={selectedDay}
            year={2025}
            month={7}
            shifts={dayShifts}
            onClose={closeDayView}
          />
        )}
      </AnimatePresence>
    </motion.div>
  )
}

export default FirstPlan
