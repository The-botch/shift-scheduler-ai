<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Issue #165 複数店舗横断シフト設計書</title>
  <style>
    :root {
      --primary: #7b3aaa;
      --primary-dark: #5c2d82;
      --secondary: #64748b;
      --success: #22c55e;
      --warning: #f59e0b;
      --danger: #ef4444;
      --bg: #f8fafc;
      --card-bg: #ffffff;
      --text: #1e293b;
      --text-muted: #64748b;
      --border: #e2e8f0;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Hiragino Sans', 'Hiragino Kaku Gothic ProN', 'Noto Sans JP', sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.7;
    }
    .container { max-width: 1200px; margin: 0 auto; padding: 2rem; }
    header {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      color: white;
      padding: 2rem;
      margin-bottom: 2rem;
    }
    header h1 { font-size: 1.8rem; margin-bottom: 0.5rem; }
    header .meta { opacity: 0.9; font-size: 0.9rem; }
    section {
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
    }
    h2 {
      font-size: 1.3rem;
      color: var(--primary);
      border-bottom: 2px solid var(--primary);
      padding-bottom: 0.5rem;
      margin-bottom: 1rem;
    }
    h3 { font-size: 1.1rem; color: var(--text); margin: 1.2rem 0 0.8rem; }
    h4 { font-size: 1rem; color: var(--secondary); margin: 1rem 0 0.5rem; }
    p { margin-bottom: 0.8rem; }
    ul, ol { margin: 0.8rem 0 0.8rem 1.5rem; }
    li { margin: 0.4rem 0; }
    table { width: 100%; border-collapse: collapse; margin: 1rem 0; font-size: 0.9rem; }
    th, td { border: 1px solid var(--border); padding: 0.6rem; text-align: left; }
    th { background: #f3e8ff; font-weight: 600; }
    code {
      background: var(--bg);
      padding: 0.2rem 0.4rem;
      border-radius: 4px;
      font-family: 'SF Mono', 'Consolas', monospace;
      font-size: 0.85em;
    }
    pre {
      background: #1e293b;
      color: #e2e8f0;
      padding: 1rem;
      border-radius: 8px;
      overflow-x: auto;
      font-size: 0.85rem;
      line-height: 1.5;
    }
    pre code { background: none; padding: 0; color: inherit; }
    .info-box {
      background: #f3e8ff;
      border-left: 4px solid var(--primary);
      padding: 1rem;
      margin: 1rem 0;
      border-radius: 0 8px 8px 0;
    }
    .warning-box {
      background: #fef3c7;
      border-left: 4px solid var(--warning);
      padding: 1rem;
      margin: 1rem 0;
      border-radius: 0 8px 8px 0;
    }
    .success-box {
      background: #f0fdf4;
      border-left: 4px solid var(--success);
      padding: 1rem;
      margin: 1rem 0;
      border-radius: 0 8px 8px 0;
    }
    .danger-box {
      background: #fef2f2;
      border-left: 4px solid var(--danger);
      padding: 1rem;
      margin: 1rem 0;
      border-radius: 0 8px 8px 0;
    }
    .tag {
      display: inline-block;
      padding: 0.2rem 0.6rem;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: 600;
      margin-right: 0.5rem;
    }
    .tag-backend { background: #dbeafe; color: #1e40af; }
    .tag-frontend { background: #dcfce7; color: #166534; }
    .tag-required { background: #fee2e2; color: #991b1b; }
    .tag-check { background: #fef3c7; color: #92400e; }
    footer {
      text-align: center;
      padding: 2rem;
      color: var(--text-muted);
      font-size: 0.875rem;
    }
    /* ワイヤーフレーム用スタイル */
    .wireframe {
      background: #ffffff;
      border: 2px solid #94a3b8;
      border-radius: 8px;
      padding: 1rem;
      margin: 1rem 0;
      font-family: 'SF Mono', 'Consolas', monospace;
      font-size: 0.8rem;
    }
    .wireframe-title {
      background: #64748b;
      color: white;
      padding: 0.5rem 1rem;
      margin: -1rem -1rem 1rem -1rem;
      border-radius: 6px 6px 0 0;
      font-weight: bold;
    }
    .wf-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.75rem;
    }
    .wf-table th, .wf-table td {
      border: 1px solid #cbd5e1;
      padding: 0.5rem;
      text-align: center;
      vertical-align: top;
    }
    .wf-table th {
      background: #e2e8f0;
      font-weight: 600;
    }
    .wf-cell-shift {
      background: #dcfce7;
      color: #166534;
      font-size: 0.7rem;
      padding: 2px 4px;
      border-radius: 3px;
      margin: 2px 0;
    }
    .wf-cell-multi {
      background: #fef3c7;
      border: 1px dashed #f59e0b;
    }
    .wf-store-badge {
      display: inline-block;
      background: #6366f1;
      color: white;
      font-size: 0.6rem;
      padding: 1px 4px;
      border-radius: 2px;
      margin-right: 4px;
    }
    .wf-store-badge.store-b {
      background: #ec4899;
    }
    .wf-divider {
      border-top: 1px dashed #94a3b8;
      margin: 4px 0;
    }
    .file-list {
      font-size: 0.85rem;
    }
    .file-list td:first-child {
      font-family: 'SF Mono', 'Consolas', monospace;
      font-size: 0.75rem;
    }
  </style>
</head>
<body>
  <header>
    <div class="container">
      <h1>Issue #165 複数店舗横断シフト設計書</h1>
      <p class="meta">
        1日に複数店舗で稼働するシフトの登録機能 |
        バージョン: 1.3 | 作成日: 2024-12-03
      </p>
    </div>
  </header>

  <div class="container">
    <!-- 概要 -->
    <section>
      <h2>1. 概要</h2>

      <h3>1.1 目的</h3>
      <p>1日の中で複数の店舗を横断して勤務するシフトを登録できる機能を実装する。</p>

      <h3>1.2 背景・ユースケース</h3>
      <ul>
        <li><strong>午前/午後分割勤務</strong>: 午前はA店舗、午後はB店舗で勤務</li>
        <li><strong>ヘルプ要員</strong>: 複数店舗を巡回する応援スタッフ</li>
        <li><strong>繁忙時間帯応援</strong>: ランチタイムのみ別店舗に応援</li>
      </ul>

      <h3>1.3 設計方針</h3>
      <div class="success-box">
        <strong>シンプルなアプローチを採用</strong>
        <p>テーブル構造の変更は不要。以下の2点のみ対応する。</p>
        <ol>
          <li><strong>時間重複バリデーション</strong>: シフト登録時に同一日・同一スタッフの時間重複をチェック</li>
          <li><strong>フロントエンド表示</strong>: 複数店舗のシフトを1セル内に表示（既存機能の確認・拡張）</li>
        </ol>
      </div>

      <div class="danger-box">
        <strong>時間重複時の制限</strong>
        <p>時間重複が検出された場合、シフトの<strong>下書き保存・承認を不可</strong>にする。</p>
      </div>
    </section>

    <!-- 修正ファイル一覧 -->
    <section>
      <h2>2. 修正ファイル一覧</h2>

      <h3>2.1 対象ファイル</h3>
      <table class="file-list">
        <tr>
          <th>ファイル</th>
          <th>使用画面</th>
          <th>変更内容</th>
          <th>種別</th>
        </tr>
        <tr>
          <td>backend/src/routes/shifts.js</td>
          <td>全シフトAPI</td>
          <td>シフト登録・更新時の時間重複バリデーション追加</td>
          <td><span class="tag tag-backend">Backend</span><span class="tag tag-required">必須</span></td>
        </tr>
        <tr>
          <td>frontend/src/components/screens/shift/<br>FirstPlanEditor.jsx</td>
          <td>第一案エディタ</td>
          <td>シフト入力ポップアップからの登録時、時間重複エラー表示<br>重複時は下書き・承認ボタン無効化</td>
          <td><span class="tag tag-frontend">Frontend</span><span class="tag tag-required">必須</span></td>
        </tr>
        <tr>
          <td>frontend/src/components/screens/shift/<br>SecondPlanEditor.jsx</td>
          <td>第二案エディタ</td>
          <td>同上</td>
          <td><span class="tag tag-frontend">Frontend</span><span class="tag tag-required">必須</span></td>
        </tr>
        <tr>
          <td>frontend/src/components/shared/<br>MultiStoreShiftTable.jsx</td>
          <td>第一案・第二案のシフト表</td>
          <td>1セル内に複数シフト表示<br>※既に応援勤務の店舗コード表示機能あり、拡張確認</td>
          <td><span class="tag tag-frontend">Frontend</span><span class="tag tag-check">要確認</span></td>
        </tr>
      </table>

      <h3>2.2 対象外ファイル（参考）</h3>
      <table class="file-list">
        <tr>
          <th>ファイル</th>
          <th>使用画面</th>
          <th>理由</th>
        </tr>
        <tr>
          <td>frontend/src/components/shared/<br>StaffTimeTable.jsx</td>
          <td>モニタリング画面<br>（Monitoring.jsx）</td>
          <td>第一案・第二案では使用されていない<br>今回のスコープ外</td>
        </tr>
        <tr>
          <td>frontend/src/components/shared/<br>ShiftTimeline.jsx</td>
          <td>日付クリック時のポップアップ</td>
          <td>複数店舗は別行で表示される<br>変更不要</td>
        </tr>
        <tr>
          <td>frontend/src/infrastructure/repositories/<br>ShiftRepository.js</td>
          <td>データ取得層</td>
          <td>storeIdフィルタなしで取得可能<br>変更不要</td>
        </tr>
      </table>

      <h3>2.3 ファイル変更サマリー</h3>
      <table>
        <tr>
          <th>種別</th>
          <th>必須</th>
          <th>要確認</th>
          <th>合計</th>
        </tr>
        <tr>
          <td>Backend</td>
          <td>1</td>
          <td>0</td>
          <td>1</td>
        </tr>
        <tr>
          <td>Frontend</td>
          <td>2</td>
          <td>1</td>
          <td>3</td>
        </tr>
        <tr>
          <td><strong>合計</strong></td>
          <td><strong>3</strong></td>
          <td><strong>1</strong></td>
          <td><strong>4</strong></td>
        </tr>
      </table>
    </section>

    <!-- バリデーション -->
    <section>
      <h2>3. 時間重複バリデーション</h2>

      <h3>3.1 バリデーションロジック</h3>
      <pre><code>/**
 * シフト登録時の時間重複チェック
 * backend/src/routes/shifts.js に追加
 */
async function validateShiftTimeOverlap(newShift) {
  // 同一日・同一スタッフの既存シフトを取得
  const existingShifts = await db.query(`
    SELECT s.*, st.store_name
    FROM ops.shifts s
    JOIN core.stores st ON s.store_id = st.store_id
    WHERE s.staff_id = $1
      AND s.shift_date = $2
      AND s.shift_id != $3
  `, [newShift.staff_id, newShift.shift_date, newShift.shift_id || 0]);

  // 時間の重複チェック
  for (const existing of existingShifts) {
    if (isTimeOverlap(newShift, existing)) {
      return {
        valid: false,
        error: `${existing.store_name}のシフト(${existing.start_time}-${existing.end_time})と時間が重複しています`,
        existingShift: existing
      };
    }
  }

  return { valid: true, error: null };
}

function isTimeOverlap(shift1, shift2) {
  const s1Start = parseTime(shift1.start_time);
  const s1End = parseTime(shift1.end_time);
  const s2Start = parseTime(shift2.start_time);
  const s2End = parseTime(shift2.end_time);

  // 重複条件: !(終了1 <= 開始2 || 終了2 <= 開始1)
  return !(s1End <= s2Start || s2End <= s1Start);
}

function parseTime(timeStr) {
  const [hours, minutes] = timeStr.split(':').map(Number);
  return hours * 60 + minutes;
}</code></pre>

      <h3>3.2 下書き・承認の制限</h3>
      <div class="warning-box">
        <strong>重複検出時の動作</strong>
        <ul>
          <li>シフト登録時: エラーメッセージを表示、登録を拒否</li>
          <li>下書き保存時: 重複があれば保存を拒否</li>
          <li>承認時: 重複があれば承認を拒否</li>
        </ul>
      </div>

      <pre><code>// FirstPlanEditor.jsx / SecondPlanEditor.jsx
// 下書き・承認ボタンの無効化ロジック

const hasTimeOverlap = useMemo(() => {
  // 全シフトをスタッフ×日付でグループ化
  const grouped = groupShiftsByStaffAndDate(shifts);

  for (const staffId in grouped) {
    for (const date in grouped[staffId]) {
      const dayShifts = grouped[staffId][date];
      if (dayShifts.length > 1) {
        // 時間重複チェック
        for (let i = 0; i < dayShifts.length; i++) {
          for (let j = i + 1; j < dayShifts.length; j++) {
            if (isTimeOverlap(dayShifts[i], dayShifts[j])) {
              return true;
            }
          }
        }
      }
    }
  }
  return false;
}, [shifts]);

// ボタン無効化
&lt;Button disabled={hasTimeOverlap}&gt;下書き保存&lt;/Button&gt;
&lt;Button disabled={hasTimeOverlap}&gt;承認&lt;/Button&gt;</code></pre>
    </section>

    <!-- ワイヤーフレーム -->
    <section>
      <h2>4. ワイヤーフレーム</h2>

      <h3>4.1 MultiStoreShiftTable（第一案・第二案で使用）</h3>
      <p>同一人物が複数店舗で勤務する場合、<strong>1つのセル内に複数シフト</strong>を表示する。</p>

      <div class="wireframe">
        <div class="wireframe-title">第一案/第二案 シフト表 - 2024年12月</div>
        <table class="wf-table">
          <tr>
            <th style="width: 80px;">日付</th>
            <th>田中太郎</th>
            <th>鈴木花子</th>
            <th>佐藤一郎</th>
            <th>高橋めぐみ</th>
          </tr>
          <tr>
            <td>12/9（月）</td>
            <td><div class="wf-cell-shift">09:00-18:00</div></td>
            <td><div class="wf-cell-shift">10:00-15:00</div></td>
            <td style="background: #f1f5f9;">-</td>
            <td><div class="wf-cell-shift">14:00-22:00</div></td>
          </tr>
          <tr>
            <td>12/10（火）</td>
            <td class="wf-cell-multi">
              <div style="margin-bottom: 4px;">
                <span class="wf-store-badge">高田馬場</span>
                <span>09:00-13:00</span>
              </div>
              <div class="wf-divider"></div>
              <div>
                <span class="wf-store-badge store-b">渋谷</span>
                <span>14:00-18:00</span>
              </div>
            </td>
            <td><div class="wf-cell-shift">10:00-18:00</div></td>
            <td><div class="wf-cell-shift">09:00-13:00</div></td>
            <td style="background: #f1f5f9;">-</td>
          </tr>
          <tr>
            <td>12/11（水）</td>
            <td><div class="wf-cell-shift">09:00-18:00</div></td>
            <td style="background: #f1f5f9;">-</td>
            <td><div class="wf-cell-shift">10:00-19:00</div></td>
            <td><div class="wf-cell-shift">09:00-17:00</div></td>
          </tr>
        </table>
        <p style="margin-top: 0.5rem; font-size: 0.7rem; color: #64748b;">
          ※ 黄色背景のセル = 複数店舗勤務日（店舗名＋時間を縦に並べて表示）
        </p>
      </div>

      <h3>4.2 時間重複エラー時の表示</h3>
      <p>時間が重複している場合は、赤色で警告表示し、下書き・承認を無効化する。</p>

      <div class="wireframe">
        <div class="wireframe-title">時間重複エラー</div>
        <table class="wf-table">
          <tr>
            <th style="width: 80px;">日付</th>
            <th>田中太郎</th>
            <th>鈴木花子</th>
          </tr>
          <tr>
            <td>12/10（火）</td>
            <td style="background: #fef2f2; border: 2px solid #ef4444;">
              <div style="margin-bottom: 4px;">
                <span class="wf-store-badge">高田馬場</span>
                <span>09:00-<strong style="color:#ef4444;">14:00</strong></span>
              </div>
              <div class="wf-divider"></div>
              <div>
                <span class="wf-store-badge store-b">渋谷</span>
                <span><strong style="color:#ef4444;">13:00</strong>-18:00</span>
              </div>
              <div style="color: #ef4444; font-size: 0.65rem; margin-top: 4px;">
                ⚠ 時間重複
              </div>
            </td>
            <td><div class="wf-cell-shift">10:00-18:00</div></td>
          </tr>
        </table>
        <div style="margin-top: 1rem; padding: 0.5rem; background: #fef2f2; border-radius: 4px;">
          <span style="color: #ef4444;">⚠ 時間重複があるため、下書き保存・承認ができません</span>
        </div>
        <div style="margin-top: 0.5rem; display: flex; gap: 0.5rem;">
          <button style="padding: 0.5rem 1rem; background: #e2e8f0; color: #94a3b8; border: none; border-radius: 4px; cursor: not-allowed;" disabled>下書き保存</button>
          <button style="padding: 0.5rem 1rem; background: #e2e8f0; color: #94a3b8; border: none; border-radius: 4px; cursor: not-allowed;" disabled>承認</button>
        </div>
      </div>

      <h3>4.3 シフト入力ポップアップ</h3>
      <p>シフト登録時に、同一日に既存シフトがある場合は警告を表示。</p>

      <div class="wireframe">
        <div class="wireframe-title">シフト入力ダイアログ</div>
        <div style="padding: 1rem; background: white; border: 1px solid #cbd5e1; border-radius: 8px;">
          <div style="font-weight: bold; margin-bottom: 1rem;">シフト登録</div>

          <div style="margin-bottom: 0.5rem;">
            <label style="font-size: 0.8rem; color: #64748b;">スタッフ</label>
            <div style="padding: 0.5rem; border: 1px solid #cbd5e1; border-radius: 4px;">田中太郎</div>
          </div>

          <div style="margin-bottom: 0.5rem;">
            <label style="font-size: 0.8rem; color: #64748b;">店舗</label>
            <div style="padding: 0.5rem; border: 1px solid #cbd5e1; border-radius: 4px;">渋谷店</div>
          </div>

          <div style="margin-bottom: 0.5rem;">
            <label style="font-size: 0.8rem; color: #64748b;">日付</label>
            <div style="padding: 0.5rem; border: 1px solid #cbd5e1; border-radius: 4px;">2024/12/10</div>
          </div>

          <div style="background: #fef3c7; padding: 0.75rem; border-radius: 4px; margin-bottom: 1rem; font-size: 0.8rem;">
            <strong>⚠ この日には既にシフトがあります</strong>
            <div style="margin-top: 0.5rem;">
              <span class="wf-store-badge">高田馬場</span> 09:00-13:00
            </div>
            <div style="margin-top: 0.25rem; color: #92400e;">
              時間が重複しないように設定してください
            </div>
          </div>

          <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
            <div style="flex: 1;">
              <label style="font-size: 0.8rem; color: #64748b;">開始時刻</label>
              <div style="padding: 0.5rem; border: 1px solid #cbd5e1; border-radius: 4px;">14:00</div>
            </div>
            <div style="flex: 1;">
              <label style="font-size: 0.8rem; color: #64748b;">終了時刻</label>
              <div style="padding: 0.5rem; border: 1px solid #cbd5e1; border-radius: 4px;">18:00</div>
            </div>
          </div>

          <div style="display: flex; gap: 0.5rem; justify-content: flex-end;">
            <button style="padding: 0.5rem 1rem; background: white; border: 1px solid #cbd5e1; border-radius: 4px;">キャンセル</button>
            <button style="padding: 0.5rem 1rem; background: #7b3aaa; color: white; border: none; border-radius: 4px;">登録</button>
          </div>
        </div>
      </div>
    </section>

    <!-- 実装計画 -->
    <section>
      <h2>5. 実装計画</h2>

      <h3>5.1 タスク一覧</h3>
      <table>
        <tr>
          <th>No</th>
          <th>タスク</th>
          <th>対象ファイル</th>
          <th>工数</th>
        </tr>
        <tr>
          <td>1</td>
          <td>時間重複バリデーション（Backend）</td>
          <td>backend/src/routes/shifts.js</td>
          <td>1.5h</td>
        </tr>
        <tr>
          <td>2</td>
          <td>第一案エディタの重複チェック・UI</td>
          <td>FirstPlanEditor.jsx</td>
          <td>2h</td>
        </tr>
        <tr>
          <td>3</td>
          <td>第二案エディタの重複チェック・UI</td>
          <td>SecondPlanEditor.jsx</td>
          <td>2h</td>
        </tr>
        <tr>
          <td>4</td>
          <td>MultiStoreShiftTable 複数シフト表示確認・拡張</td>
          <td>MultiStoreShiftTable.jsx</td>
          <td>1h</td>
        </tr>
        <tr>
          <td>5</td>
          <td>テスト</td>
          <td>-</td>
          <td>1.5h</td>
        </tr>
      </table>

      <h3>5.2 合計工数</h3>
      <p><strong>約8時間</strong>（テスト含む）</p>
    </section>

    <!-- テスト計画 -->
    <section>
      <h2>6. テスト計画</h2>

      <table>
        <tr>
          <th>No</th>
          <th>テスト項目</th>
          <th>入力</th>
          <th>期待結果</th>
        </tr>
        <tr>
          <td>1</td>
          <td>同一日・異店舗・重複なし</td>
          <td>A店 09:00-13:00 → B店 14:00-18:00</td>
          <td>両方登録成功</td>
        </tr>
        <tr>
          <td>2</td>
          <td>同一日・異店舗・重複あり</td>
          <td>A店 09:00-14:00 → B店 13:00-18:00</td>
          <td>エラー表示、登録拒否</td>
        </tr>
        <tr>
          <td>3</td>
          <td>境界時刻（隣接）</td>
          <td>A店 09:00-13:00 → B店 13:00-18:00</td>
          <td>登録成功（重複なし）</td>
        </tr>
        <tr>
          <td>4</td>
          <td>重複ありで下書き保存</td>
          <td>重複シフトが存在する状態</td>
          <td>ボタン無効、保存不可</td>
        </tr>
        <tr>
          <td>5</td>
          <td>重複ありで承認</td>
          <td>重複シフトが存在する状態</td>
          <td>ボタン無効、承認不可</td>
        </tr>
        <tr>
          <td>6</td>
          <td>シフト表表示（複数店舗）</td>
          <td>同一人物2店舗シフト</td>
          <td>1セル内に2シフト表示（店舗名付き）</td>
        </tr>
      </table>
    </section>
  </div>

  <footer>
    <p>Issue #165 複数店舗横断シフト設計書 v1.3 | &copy; 2024 Stand Banh Mi</p>
  </footer>
</body>
</html>
