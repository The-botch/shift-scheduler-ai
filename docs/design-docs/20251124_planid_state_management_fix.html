<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>planId状態管理の修正 - 設計書</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
            color: #333;
            background-color: #f5f5f5;
        }
        h1 {
            color: #2c3e50;
            border-bottom: 3px solid #3498db;
            padding-bottom: 10px;
        }
        h2 {
            color: #34495e;
            margin-top: 30px;
            border-left: 4px solid #3498db;
            padding-left: 10px;
        }
        h3 {
            color: #555;
            margin-top: 20px;
        }
        .section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .error-box {
            background-color: #f8d7da;
            border-left: 4px solid #dc3545;
            padding: 15px;
            margin: 15px 0;
            border-radius: 4px;
        }
        .success-box {
            background-color: #d4edda;
            border-left: 4px solid #28a745;
            padding: 15px;
            margin: 15px 0;
            border-radius: 4px;
        }
        .important {
            background-color: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px;
            margin: 15px 0;
        }
        .code {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            overflow-x: auto;
            font-size: 14px;
        }
        .diff-remove {
            background-color: #ffebee;
            color: #c62828;
            padding: 2px 4px;
        }
        .diff-add {
            background-color: #e8f5e9;
            color: #2e7d32;
            padding: 2px 4px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }
        th {
            background-color: #3498db;
            color: white;
        }
        tr:nth-child(even) {
            background-color: #f2f2f2;
        }
        .flow-diagram {
            background: #ffffff;
            border: 2px solid #3498db;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            font-family: monospace;
            white-space: pre;
            overflow-x: auto;
        }
        .metadata {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .metadata p {
            margin: 5px 0;
        }
    </style>
</head>
<body>
    <h1>planId状態管理の修正 - 設計書</h1>

    <div class="metadata">
        <p><strong>作成日:</strong> 2024-11-24</p>
        <p><strong>対象コンポーネント:</strong> FirstPlanEditor.jsx</p>
        <p><strong>修正種別:</strong> バグ修正</p>
        <p><strong>優先度:</strong> 高（シフト作成機能が動作しない重大なバグ）</p>
    </div>

    <div class="section">
        <h2>1. 問題の概要</h2>
        <div class="error-box">
            <h3>発生した問題</h3>
            <p>FirstPlanEditorコンポーネントでシフトを追加しようとすると、以下のエラーが発生し、シフト作成に失敗する：</p>
            <div class="code">
シフト作成エラー: Error: HTTP error! status: 400
            </div>
        </div>

        <h3>エラーが発生した状況</h3>
        <ul>
            <li>ユーザーがシフト編集画面でシフトを追加</li>
            <li>モーダルで時刻を入力して保存</li>
            <li>「下書き保存」ボタンをクリック</li>
            <li>バックエンドAPIへのPOSTリクエストが400エラーで失敗</li>
        </ul>

        <h3>コンソールログ</h3>
        <div class="code">
DraftShiftEditor - selectedShift: Object
DraftShiftEditor - planId: <strong style="color: red;">undefined</strong>
DraftShiftEditor - planType: FIRST
...
シフト作成エラー: Error: HTTP error! status: 400
        </div>
    </div>

    <div class="section">
        <h2>2. 根本原因の分析</h2>

        <h3>2.1 バックエンドAPIの要件</h3>
        <p>POST /api/shifts エンドポイントは以下のフィールドを<strong>必須</strong>としている：</p>
        <table>
            <tr>
                <th>フィールド名</th>
                <th>型</th>
                <th>説明</th>
            </tr>
            <tr>
                <td>tenant_id</td>
                <td>number</td>
                <td>テナントID</td>
            </tr>
            <tr>
                <td>store_id</td>
                <td>number</td>
                <td>店舗ID</td>
            </tr>
            <tr>
                <td><strong style="color: red;">plan_id</strong></td>
                <td>number</td>
                <td>シフトプランID</td>
            </tr>
            <tr>
                <td>staff_id</td>
                <td>number</td>
                <td>スタッフID</td>
            </tr>
            <tr>
                <td>shift_date</td>
                <td>string</td>
                <td>シフト日付 (YYYY-MM-DD)</td>
            </tr>
            <tr>
                <td>pattern_id</td>
                <td>number</td>
                <td>シフトパターンID</td>
            </tr>
            <tr>
                <td>start_time</td>
                <td>string</td>
                <td>開始時刻</td>
            </tr>
            <tr>
                <td>end_time</td>
                <td>string</td>
                <td>終了時刻</td>
            </tr>
            <tr>
                <td>break_minutes</td>
                <td>number</td>
                <td>休憩時間（分）</td>
            </tr>
        </table>

        <h3>2.2 フロントエンドの問題</h3>
        <p>FirstPlanEditorコンポーネントで、<code>planId</code>が以下のように定義されていた：</p>
        <div class="code">
<span class="diff-remove">const planId = selectedShift?.planId || selectedShift?.plan_id</span>
        </div>

        <div class="important">
            <strong>問題点：</strong>
            <ul>
                <li><code>selectedShift</code>プロパティから<code>planId</code>を取得しようとしているが、親コンポーネント（ShiftManagement.jsx）から渡される<code>viewingShift</code>オブジェクトには<code>planId</code>や<code>plan_id</code>プロパティが含まれていない</li>
                <li>シフトデータを読み込んでも、取得したシフトから<code>plan_id</code>を抽出して状態に保存する処理がなかった</li>
                <li>結果として<code>planId</code>は常に<code>undefined</code>となり、新規シフト作成時にバックエンドAPIへのリクエストが失敗していた</li>
            </ul>
        </div>

        <h3>2.3 データフロー（修正前）</h3>
        <div class="flow-diagram">
ShiftManagement.jsx
    ↓ setViewingShift({ year, month, planType })
    ↓ (planIdプロパティが含まれていない！)
    ↓
FirstPlanEditor.jsx
    ↓ const planId = selectedShift?.planId || selectedShift?.plan_id
    ↓ → undefined
    ↓
loadShiftData()
    ↓ シフトデータを取得（plan_idフィールドを含む）
    ↓ しかし、plan_idを抽出・保存していない
    ↓
handleAddShift()
    ↓ plan_id: planId  ← undefined！
    ↓
shiftRepository.createShift()
    ↓ バックエンドに送信
    ↓ { ..., plan_id: undefined, ... }
    ↓
POST /api/shifts
    ✗ 400 Bad Request: Missing required field 'plan_id'
        </div>
    </div>

    <div class="section">
        <h2>3. 解決策の設計</h2>

        <h3>3.1 設計方針</h3>
        <p>以下の3つのステップで問題を解決する：</p>
        <ol>
            <li><strong>状態変数の追加：</strong> <code>planId</code>を状態として管理する変数 <code>planIdState</code> を追加</li>
            <li><strong>データ読み込み時の抽出：</strong> シフトデータ読み込み時に、取得したシフトから <code>plan_id</code> を抽出して状態に保存</li>
            <li><strong>フォールバック機構：</strong> propsから取得できない場合は、状態変数にフォールバックする</li>
        </ol>

        <h3>3.2 実装設計</h3>

        <h4>変更1: 状態変数の追加</h4>
        <div class="code">
// FirstPlanEditor.jsx (行85)
const [storeId, setStoreId] = useState(null)
<span class="diff-add">const [planIdState, setPlanIdState] = useState(null) // 状態として保持するplanId</span>
const [defaultPatternId, setDefaultPatternId] = useState(null)
        </div>

        <h4>変更2: planId計算ロジックの修正</h4>
        <div class="code">
// FirstPlanEditor.jsx (行99)
<span class="diff-remove">const planId = selectedShift?.planId || selectedShift?.plan_id</span>
<span class="diff-add">const planId = selectedShift?.planId || selectedShift?.plan_id || planIdState</span>
        </div>
        <p>propsから取得できない場合、状態変数 <code>planIdState</code> にフォールバックする。</p>

        <h4>変更3: loadShiftData関数での抽出</h4>
        <div class="code">
// FirstPlanEditor.jsx (行189-197)
// シフトデータから店舗ID、pattern_id<span class="diff-add">、plan_id</span>を取得
const fetchedStoreId = shiftsResult.length > 0 ? shiftsResult[0].store_id : null
const fetchedPatternId = shiftsResult.length > 0 ? shiftsResult[0].pattern_id : null
<span class="diff-add">const fetchedPlanId = shiftsResult.length > 0 ? shiftsResult[0].plan_id : null</span>

// ステートに保存
setStoreId(fetchedStoreId)
setDefaultPatternId(fetchedPatternId)
<span class="diff-add">setPlanIdState(fetchedPlanId)</span>
        </div>

        <h4>変更4: loadInitialData関数での抽出</h4>
        <div class="code">
// FirstPlanEditor.jsx (行129-149)
const allShifts = []
<span class="diff-add">let extractedPlanId = null</span>
initialData.stores.forEach(store => {
  store.shifts.forEach(shift => {
    <span class="diff-add">// 最初のシフトからplan_idを抽出
    if (!extractedPlanId && shift.plan_id) {
      extractedPlanId = shift.plan_id
    }</span>
    const staffInfo = staffMapping[shift.staff_id] || { name: '不明', role_name: 'スタッフ' }
    allShifts.push({
      ...shift,
      staff_name: staffInfo.name,
      role: staffInfo.role_name,
      modified_flag: false,
    })
  })
})

<span class="diff-add">// plan_idを状態に保存
if (extractedPlanId) {
  setPlanIdState(extractedPlanId)
}</span>
        </div>
    </div>

    <div class="section">
        <h2>4. 修正後のデータフロー</h2>
        <div class="flow-diagram">
ShiftManagement.jsx
    ↓ setViewingShift({ year, month, planType })
    ↓
FirstPlanEditor.jsx
    ↓ const planId = selectedShift?.planId || selectedShift?.plan_id || planIdState
    ↓ → まだundefined（初回レンダリング時）
    ↓
loadShiftData() または loadInitialData()
    ↓ シフトデータを取得（plan_idフィールドを含む）
    ↓ fetchedPlanId = shiftsResult[0].plan_id
    ↓ setPlanIdState(fetchedPlanId) ← 状態に保存！
    ↓
再レンダリング
    ↓ const planId = selectedShift?.planId || selectedShift?.plan_id || planIdState
    ↓ → planIdState の値が使用される ✓
    ↓
handleAddShift()
    ↓ plan_id: planId  ← 正しい値！
    ↓
shiftRepository.createShift()
    ↓ バックエンドに送信
    ↓ { ..., plan_id: 123, ... }  ← 正しいデータ
    ↓
POST /api/shifts
    ✓ 201 Created: シフト作成成功
        </div>
    </div>

    <div class="section">
        <h2>5. 影響範囲の分析</h2>

        <h3>5.1 変更対象ファイル</h3>
        <table>
            <tr>
                <th>ファイルパス</th>
                <th>変更内容</th>
                <th>行数</th>
            </tr>
            <tr>
                <td>frontend/src/components/screens/shift/FirstPlanEditor.jsx</td>
                <td>
                    <ul>
                        <li>planIdState状態変数の追加</li>
                        <li>planId計算ロジックの修正</li>
                        <li>loadShiftData関数の修正</li>
                        <li>loadInitialData関数の修正</li>
                    </ul>
                </td>
                <td>4箇所（約10行）</td>
            </tr>
        </table>

        <h3>5.2 影響を受ける機能</h3>
        <div class="success-box">
            <h4>修正により改善される機能：</h4>
            <ul>
                <li><strong>シフト新規作成</strong> - 動作するようになる</li>
                <li><strong>下書き保存</strong> - 正常に保存できるようになる</li>
                <li><strong>前月コピー機能</strong> - initialDataを使用する場合も正しく動作</li>
            </ul>
        </div>

        <h3>5.3 後方互換性</h3>
        <div class="important">
            <p><strong>後方互換性：</strong> 完全に保持される</p>
            <ul>
                <li>既存の動作（propsから<code>planId</code>が渡される場合）はそのまま動作</li>
                <li>新しいロジックはフォールバックとして機能するため、既存コードを破壊しない</li>
                <li>状態管理が追加されるだけで、既存の機能には影響しない</li>
            </ul>
        </div>
    </div>

    <div class="section">
        <h2>6. テスト観点</h2>

        <h3>6.1 動作確認項目</h3>
        <table>
            <tr>
                <th>テストケース</th>
                <th>確認内容</th>
                <th>期待結果</th>
            </tr>
            <tr>
                <td>シフト新規作成</td>
                <td>シフト編集画面で新しいシフトを追加し、「下書き保存」をクリック</td>
                <td>400エラーが発生せず、シフトが正常に作成される</td>
            </tr>
            <tr>
                <td>前月コピー後のシフト追加</td>
                <td>前月コピー機能を使用してシフトを作成し、さらにシフトを追加</td>
                <td>追加シフトが正常に保存される</td>
            </tr>
            <tr>
                <td>既存シフトの編集</td>
                <td>既存のシフトを編集して保存</td>
                <td>既存動作が変わらず正常に保存される</td>
            </tr>
            <tr>
                <td>既存シフトの削除</td>
                <td>既存のシフトを削除して保存</td>
                <td>既存動作が変わらず正常に削除される</td>
            </tr>
            <tr>
                <td>複数シフトの一括操作</td>
                <td>追加・編集・削除を複数行い一括保存</td>
                <td>すべての変更が正常に反映される</td>
            </tr>
        </table>

        <h3>6.2 コンソールログ確認</h3>
        <p>修正後、以下のログで<code>planId</code>が正しく設定されていることを確認：</p>
        <div class="code">
DraftShiftEditor - selectedShift: Object
DraftShiftEditor - planId: <span class="diff-add">123</span> // undefined → 数値に修正される
DraftShiftEditor - planType: FIRST
        </div>
    </div>

    <div class="section">
        <h2>7. 将来的な改善提案</h2>

        <h3>7.1 親コンポーネントからplanIdを渡す</h3>
        <p>現在の実装では、FirstPlanEditorがシフトデータから<code>plan_id</code>を抽出しているが、本来は親コンポーネント（ShiftManagement.jsx）が<code>planId</code>を明示的に渡すべき。</p>

        <div class="code">
// ShiftManagement.jsx での改善案
const handleViewDraft = (shift, planType = 'FIRST') => {
  <span class="diff-add">// planIdを事前に取得して渡す
  const planId = await getPlanId(shift.year, shift.month, planType)</span>

  setViewingShift({
    ...shift,
    planType,
    <span class="diff-add">planId,  // 明示的に渡す</span>
  })
  setViewMode('draft')
}
        </div>

        <h3>7.2 TypeScript化</h3>
        <p>型定義を追加することで、<code>planId</code>の欠落を開発時に検出できるようになる：</p>
        <div class="code">
interface ViewingShift {
  year: number
  month: number
  planType: 'FIRST' | 'SECOND'
  planId: number  // 必須フィールドとして定義
  storeId?: number
  initialData?: any
}
        </div>

        <h3>7.3 バリデーション強化</h3>
        <p>シフト作成前に必須フィールドをバリデーションすることで、より明確なエラーメッセージを表示：</p>
        <div class="code">
const handleAddShift = (newShiftData) => {
  <span class="diff-add">// バリデーション
  if (!planId) {
    console.error('planIdが設定されていません')
    alert('シフトプランIDが取得できません。画面をリロードしてください。')
    return
  }</span>

  // シフト作成処理...
}
        </div>
    </div>

    <div class="section">
        <h2>8. まとめ</h2>

        <h3>問題</h3>
        <p><code>planId</code>が<code>undefined</code>のため、シフト新規作成時に400エラーが発生していた。</p>

        <h3>原因</h3>
        <p>シフトデータを読み込んでも、その中の<code>plan_id</code>フィールドを抽出して状態に保存する処理がなかった。</p>

        <h3>解決策</h3>
        <p><code>planIdState</code>状態変数を追加し、シフトデータ読み込み時に<code>plan_id</code>を抽出して保存するようにした。</p>

        <h3>結果</h3>
        <div class="success-box">
            <ul>
                <li>シフト新規作成が正常に動作するようになった</li>
                <li>後方互換性を保持したまま修正を実施</li>
                <li>最小限の変更で問題を解決（約10行の追加・修正）</li>
            </ul>
        </div>
    </div>

</body>
</html>