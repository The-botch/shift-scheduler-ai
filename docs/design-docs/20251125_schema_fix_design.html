<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>schema.sqlä¿®æ­£ - è¨­è¨ˆæ›¸</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background: #f5f5f5;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 40px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border-radius: 8px;
        }

        h1 {
            color: #2c3e50;
            border-bottom: 4px solid #e74c3c;
            padding-bottom: 15px;
            margin-bottom: 30px;
            font-size: 2.5em;
        }

        h2 {
            color: #2c3e50;
            margin-top: 40px;
            margin-bottom: 20px;
            font-size: 1.8em;
            border-left: 5px solid #e74c3c;
            padding-left: 15px;
        }

        h3 {
            color: #34495e;
            margin-top: 25px;
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        .error-box {
            background: #fee;
            border-left: 4px solid #e74c3c;
            padding: 15px;
            margin: 20px 0;
            border-radius: 4px;
        }

        .error-box strong {
            color: #c0392b;
        }

        .warning {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px;
            margin: 20px 0;
            border-radius: 4px;
        }

        .success {
            background: #d4edda;
            border-left: 4px solid #28a745;
            padding: 15px;
            margin: 20px 0;
            border-radius: 4px;
        }

        .code-block {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 20px;
            border-radius: 5px;
            overflow-x: auto;
            margin: 15px 0;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }

        .code-block pre {
            margin: 0;
        }

        .diff-removed {
            background: #fdd;
            color: #c00;
            text-decoration: line-through;
        }

        .diff-added {
            background: #dfd;
            color: #080;
            font-weight: bold;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background: white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        th {
            background: #e74c3c;
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: bold;
        }

        td {
            padding: 12px 15px;
            border-bottom: 1px solid #dee2e6;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .step-list {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 5px;
            margin: 20px 0;
        }

        .step-list li {
            margin: 10px 0;
            padding: 10px;
            background: white;
            border-left: 4px solid #e74c3c;
            padding-left: 15px;
        }

        .impact-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 3px;
            font-size: 0.85em;
            font-weight: bold;
            margin-left: 5px;
        }

        .impact-high {
            background: #e74c3c;
            color: white;
        }

        .impact-medium {
            background: #f39c12;
            color: white;
        }

        .impact-low {
            background: #2ecc71;
            color: white;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ schema.sqlä¿®æ­£ - è¨­è¨ˆæ›¸</h1>

        <div class="error-box">
            <strong>ğŸš¨ å•é¡Œã®æ¦‚è¦:</strong>
            <p style="margin-top: 10px;">STGç’°å¢ƒã§DDL/DMLå®Ÿè¡Œæ™‚ã«ã€<code>shift_preferences</code>ãƒ†ãƒ¼ãƒ–ãƒ«ã®UNIQUEåˆ¶ç´„è¿½åŠ ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã€‚å­˜åœ¨ã—ãªã„ã‚«ãƒ©ãƒ <code>preference_date</code>ã‚’å‚ç…§ã—ã¦ã„ã‚‹ãŸã‚ã€‚</p>
        </div>

        <h2>1. ã‚¨ãƒ©ãƒ¼è©³ç´°</h2>

        <div class="code-block">
<pre>âŒ ã‚¨ãƒ©ãƒ¼: column "preference_date" named in key does not exist
error: column "preference_date" named in key does not exist

where: 'SQL statement "ALTER TABLE ops.shift_preferences
    ADD CONSTRAINT unique_shift_preference_per_staff_date
    UNIQUE (tenant_id, staff_id, preference_date)"
PL/pgSQL function inline_code_block line 7 at SQL statement'</pre>
        </div>

        <h3>ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿç®‡æ‰€</h3>
        <p><strong>ãƒ•ã‚¡ã‚¤ãƒ«:</strong> <code>scripts/database/ddl/schema.sql</code></p>
        <p><strong>è¡Œç•ªå·:</strong> 873è¡Œç›®</p>

        <h2>2. åŸå› åˆ†æ</h2>

        <h3>2-1. shift_preferencesãƒ†ãƒ¼ãƒ–ãƒ«ã®å®šç¾©ï¼ˆ392-414è¡Œç›®ï¼‰</h3>
        <div class="code-block">
<pre>CREATE TABLE IF NOT EXISTS ops.shift_preferences (
    preference_id SERIAL PRIMARY KEY,
    tenant_id INT NOT NULL,
    store_id INT NOT NULL,
    staff_id INT NOT NULL,
    staff_name VARCHAR(100),
    year INT NOT NULL,              â† âœ… å¹´ã‚’å€‹åˆ¥ã«ç®¡ç†
    month INT NOT NULL,             â† âœ… æœˆã‚’å€‹åˆ¥ã«ç®¡ç†
    preferred_days TEXT,
    ng_days TEXT,
    preferred_time_slots TEXT,
    max_hours_per_week DECIMAL(5,2),
    notes TEXT,
    submitted_at TIMESTAMP,
    status VARCHAR(20) DEFAULT 'PENDING',
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    ...
);</pre>
        </div>

        <h3>2-2. UNIQUEåˆ¶ç´„ã®è¿½åŠ ï¼ˆ865-875è¡Œç›®ï¼‰</h3>
        <div class="code-block">
<pre>DO $$
BEGIN
  IF NOT EXISTS (
    SELECT 1 FROM pg_constraint
    WHERE conname = 'unique_shift_preference_per_staff_date'
  ) THEN
    ALTER TABLE ops.shift_preferences
    ADD CONSTRAINT unique_shift_preference_per_staff_date
    <span class="diff-removed">UNIQUE (tenant_id, staff_id, preference_date);</span>  â† âŒ å­˜åœ¨ã—ãªã„ã‚«ãƒ©ãƒ 
  END IF;
END $$;</pre>
        </div>

        <div class="warning">
            <strong>âš ï¸ å•é¡Œç‚¹:</strong>
            <ul style="margin-left: 20px; margin-top: 10px;">
                <li><code>shift_preferences</code>ãƒ†ãƒ¼ãƒ–ãƒ«ã«ã¯<code>preference_date</code>ã‚«ãƒ©ãƒ ãŒå­˜åœ¨ã—ãªã„</li>
                <li>ä»£ã‚ã‚Šã«<code>year</code>ã¨<code>month</code>ã‚«ãƒ©ãƒ ã§æœŸé–“ã‚’ç®¡ç†ã—ã¦ã„ã‚‹</li>
                <li>UNIQUEåˆ¶ç´„ã¯<code>(tenant_id, staff_id, year, month)</code>ã§ã‚ã‚‹ã¹ã</li>
            </ul>
        </div>

        <h2>3. ä¿®æ­£æ–¹é‡</h2>

        <table>
            <thead>
                <tr>
                    <th>é …ç›®</th>
                    <th>ç¾çŠ¶</th>
                    <th>ä¿®æ­£å¾Œ</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td><strong>åˆ¶ç´„å</strong></td>
                    <td><code>unique_shift_preference_per_staff_date</code></td>
                    <td><code>unique_shift_preference_per_staff_period</code></td>
                </tr>
                <tr>
                    <td><strong>UNIQUEåˆ¶ç´„</strong></td>
                    <td><code>(tenant_id, staff_id, preference_date)</code></td>
                    <td><code>(tenant_id, staff_id, year, month)</code></td>
                </tr>
                <tr>
                    <td><strong>å½±éŸ¿ç¯„å›²</strong></td>
                    <td colspan="2">
                        <span class="impact-badge impact-low">LOW</span>
                        DDLã®ã¿ã®ä¿®æ­£ã€æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã¸ã®å½±éŸ¿ãªã—
                    </td>
                </tr>
            </tbody>
        </table>

        <h2>4. ä¿®æ­£å†…å®¹</h2>

        <h3>4-1. schema.sqlï¼ˆ865-875è¡Œç›®ï¼‰</h3>

        <div class="code-block">
<pre><span style="color: #95a5a6;">-- ä¿®æ­£å‰</span>
DO $$
BEGIN
  IF NOT EXISTS (
    SELECT 1 FROM pg_constraint
    WHERE conname = '<span class="diff-removed">unique_shift_preference_per_staff_date</span>'
  ) THEN
    ALTER TABLE ops.shift_preferences
    ADD CONSTRAINT <span class="diff-removed">unique_shift_preference_per_staff_date</span>
    UNIQUE (tenant_id, staff_id, <span class="diff-removed">preference_date</span>);
  END IF;
END $$;

<span style="color: #95a5a6;">-- ä¿®æ­£å¾Œ</span>
DO $$
BEGIN
  IF NOT EXISTS (
    SELECT 1 FROM pg_constraint
    WHERE conname = '<span class="diff-added">unique_shift_preference_per_staff_period</span>'
  ) THEN
    ALTER TABLE ops.shift_preferences
    ADD CONSTRAINT <span class="diff-added">unique_shift_preference_per_staff_period</span>
    UNIQUE (tenant_id, staff_id, <span class="diff-added">year, month</span>);
  END IF;
END $$;</pre>
        </div>

        <h2>5. å½±éŸ¿ç¯„å›²ã®ç¢ºèª</h2>

        <table>
            <thead>
                <tr>
                    <th>å¯¾è±¡</th>
                    <th>å½±éŸ¿</th>
                    <th>å¯¾å¿œ</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td><strong>schema.sql</strong></td>
                    <td><span class="impact-badge impact-low">LOW</span> 1ç®‡æ‰€ã®ã¿ä¿®æ­£</td>
                    <td>873è¡Œç›®ã®åˆ¶ç´„å®šç¾©ã‚’ä¿®æ­£</td>
                </tr>
                <tr>
                    <td><strong>æ—¢å­˜ã®DB</strong></td>
                    <td><span class="impact-badge impact-low">LOW</span> å½±éŸ¿ãªã—</td>
                    <td>STGç’°å¢ƒã¯å†æ§‹ç¯‰ã€PRDç’°å¢ƒã¯æœªä½¿ç”¨</td>
                </tr>
                <tr>
                    <td><strong>ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³</strong></td>
                    <td><span class="impact-badge impact-low">LOW</span> å½±éŸ¿ãªã—</td>
                    <td>åˆ¶ç´„åã®å¤‰æ›´ã®ã¿ã€ãƒ­ã‚¸ãƒƒã‚¯ã¯å¤‰æ›´ä¸è¦</td>
                </tr>
                <tr>
                    <td><strong>DMLãƒ•ã‚¡ã‚¤ãƒ«</strong></td>
                    <td><span class="impact-badge impact-low">LOW</span> å½±éŸ¿ãªã—</td>
                    <td>ä¿®æ­£ä¸è¦</td>
                </tr>
            </tbody>
        </table>

        <h2>6. å®Ÿè£…æ‰‹é †</h2>

        <ol class="step-list">
            <li><strong>schema.sqlã®ä¿®æ­£</strong>
                <ul style="margin-left: 20px; margin-top: 5px;">
                    <li>873è¡Œç›®: <code>preference_date</code> â†’ <code>year, month</code></li>
                    <li>åˆ¶ç´„å: <code>unique_shift_preference_per_staff_date</code> â†’ <code>unique_shift_preference_per_staff_period</code></li>
                </ul>
            </li>
            <li><strong>DDL/DMLã®å®Ÿè¡Œ</strong>
                <ul style="margin-left: 20px; margin-top: 5px;">
                    <li>ä¿®æ­£ã—ãŸschema.sqlã§STGç’°å¢ƒã‚’å†æ§‹ç¯‰</li>
                    <li><code>node scripts/run-ddl-dml-stg.mjs</code>ã‚’å®Ÿè¡Œ</li>
                </ul>
            </li>
            <li><strong>å‹•ä½œç¢ºèª</strong>
                <ul style="margin-left: 20px; margin-top: 5px;">
                    <li>DDL/DMLãŒæ­£å¸¸ã«å®Œäº†ã™ã‚‹ã“ã¨ã‚’ç¢ºèª</li>
                    <li>ãƒ†ãƒ¼ãƒ–ãƒ«æ§‹æˆã‚’ç¢ºèª</li>
                    <li>åˆ¶ç´„ãŒæ­£ã—ãä½œæˆã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª</li>
                </ul>
            </li>
            <li><strong>ã‚³ãƒŸãƒƒãƒˆ</strong>
                <ul style="margin-left: 20px; margin-top: 5px;">
                    <li>ä¿®æ­£ã‚’ã‚³ãƒŸãƒƒãƒˆ</li>
                    <li>è¨­è¨ˆæ›¸ã‚‚ä½µã›ã¦ã‚³ãƒŸãƒƒãƒˆ</li>
                </ul>
            </li>
        </ol>

        <h2>7. ç¢ºèªé …ç›®</h2>

        <div class="success">
            <strong>âœ… ç¢ºèªé …ç›®:</strong>
            <ul style="margin-left: 20px; margin-top: 10px;">
                <li>[ ] schema.sqlã®ä¿®æ­£ãŒå®Œäº†ã—ã¦ã„ã‚‹</li>
                <li>[ ] DDL/DMLå®Ÿè¡ŒãŒã‚¨ãƒ©ãƒ¼ãªãå®Œäº†ã™ã‚‹</li>
                <li>[ ] <code>shift_preferences</code>ãƒ†ãƒ¼ãƒ–ãƒ«ãŒæ­£ã—ãä½œæˆã•ã‚Œã¦ã„ã‚‹</li>
                <li>[ ] UNIQUEåˆ¶ç´„<code>unique_shift_preference_per_staff_period</code>ãŒä½œæˆã•ã‚Œã¦ã„ã‚‹</li>
                <li>[ ] ãƒ†ãƒŠãƒ³ãƒˆ3ã®ãƒã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿ãŒæŠ•å…¥ã•ã‚Œã¦ã„ã‚‹</li>
                <li>[ ] ã‚¹ã‚¿ãƒƒãƒ•ã€åº—èˆ—ãƒ‡ãƒ¼ã‚¿ãŒæ­£ã—ãç™»éŒ²ã•ã‚Œã¦ã„ã‚‹</li>
            </ul>
        </div>

        <h2>8. ã¾ã¨ã‚</h2>

        <div class="success">
            <strong>âœ… ä¿®æ­£ã®ãƒã‚¤ãƒ³ãƒˆ:</strong>
            <ul style="margin-left: 20px; margin-top: 10px;">
                <li><code>shift_preferences</code>ãƒ†ãƒ¼ãƒ–ãƒ«ã¯<code>year</code>ã¨<code>month</code>ã§æœŸé–“ã‚’ç®¡ç†</li>
                <li>UNIQUEåˆ¶ç´„ã¯<code>(tenant_id, staff_id, year, month)</code>ã§ä¸€æ„æ€§ã‚’ä¿è¨¼</li>
                <li>ä¿®æ­£ç®‡æ‰€ã¯1ç®‡æ‰€ã®ã¿ã§ã€å½±éŸ¿ç¯„å›²ã¯é™å®šçš„</li>
                <li>DDLä¿®æ­£ã®ã¿ã§ã€DMLã‚„ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚³ãƒ¼ãƒ‰ã®å¤‰æ›´ã¯ä¸è¦</li>
            </ul>
        </div>
    </div>
</body>
</html>
